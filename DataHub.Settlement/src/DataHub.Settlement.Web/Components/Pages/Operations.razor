@page "/operations"
@using System.Text.Json
@using DataHub.Settlement.Application.AddressLookup
@using DataHub.Settlement.Infrastructure.Dashboard
@inject IAddressLookupClient AddressLookup
@inject SimulationService Simulator
@inject SimulatedClock Clock
@inject IHttpClientFactory HttpClientFactory

<div class="flex items-center justify-between mb-2">
    <h1 class="text-2xl font-extrabold text-white tracking-tight">Operations</h1>
    <button class="px-3 py-1.5 text-xs font-semibold border border-rose-500/60 rounded-md bg-transparent text-rose-400 hover:bg-rose-500 hover:text-white transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed"
            @onclick="ResetDatabaseAsync" disabled="@_resetting">
        @(_resetting ? "Resetting..." : "Reset Database")
    </button>
</div>
<p class="text-sm text-slate-400 mb-6">Search an address, find metering points, and run concurrent change-of-supplier actions.</p>

<!-- Clock Bar -->
<div class="flex items-center justify-between px-5 py-3.5 bg-white/[0.03] backdrop-blur-sm border border-white/[0.06] border-l-2 border-l-blue-500 rounded-xl mb-6">
    <div class="font-mono text-lg font-semibold tabular-nums text-white">@Clock.CurrentDate.ToString("ddd, dd MMM yyyy")</div>
    <div class="flex gap-1.5">
        <button class="px-3 py-1.5 text-xs font-semibold border border-white/[0.08] rounded-md bg-white/[0.03] text-slate-300 hover:bg-white/[0.06] hover:border-blue-500/50 transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed"
                @onclick="AdvanceOneDayAsync" disabled="@_ticking">+1 Day</button>
        <button class="px-3 py-1.5 text-xs font-semibold border border-blue-500/40 rounded-md bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed"
                @onclick="SkipToNextEventAsync" disabled="@_ticking">Skip to Next Event</button>
        <button class="px-3 py-1.5 text-xs font-semibold border border-white/[0.08] rounded-md bg-white/[0.03] text-slate-300 hover:bg-white/[0.06] hover:border-blue-500/50 transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed"
                @onclick="AdvanceSevenDaysAsync" disabled="@_ticking">+7 Days</button>
    </div>
</div>

<!-- Address Search -->
<div class="flex items-center gap-3 mb-6">
    <div class="relative flex-1 max-w-xl">
        <input type="text"
               class="w-full px-4 py-2.5 text-sm bg-slate-950 border border-white/[0.08] rounded-lg text-slate-200 placeholder-slate-600 outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/20 transition-all duration-150"
               placeholder="Search Danish address (e.g. Rendsburggade 1)..."
               value="@_searchQuery"
               @oninput="OnSearchInput" />
        @if (_suggestions.Count > 0 && !_addressSelected)
        {
            <div class="absolute z-40 top-full left-0 right-0 mt-1 bg-slate-900 border border-white/[0.08] rounded-lg shadow-xl shadow-black/30 overflow-hidden">
                @foreach (var s in _suggestions)
                {
                    <div class="px-4 py-2.5 text-sm text-slate-300 hover:bg-white/[0.05] cursor-pointer transition-colors duration-100"
                         @onclick="() => SelectAddress(s)">@s.Text</div>
                }
            </div>
        }
    </div>
    @if (_searching)
    {
        <span class="text-sm text-slate-500">Searching...</span>
    }
</div>

<!-- Metering Point Card -->
@if (_selectedMeteringPoints.Count > 0)
{
    <div class="flex flex-col gap-3 mb-6">
        @foreach (var mp in _selectedMeteringPoints)
        {
            <div class="relative bg-white/[0.03] backdrop-blur-sm border border-white/[0.06] rounded-xl p-5">
                <div class="absolute inset-y-0 left-0 w-[2px] rounded-l-xl bg-gradient-to-b from-emerald-400 to-emerald-600"></div>
                <div class="flex items-center gap-3 mb-1">
                    <span class="font-mono font-bold text-sm text-white tabular-nums">@mp.Gsrn</span>
                    <span class="inline-block px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide rounded-md bg-emerald-500/15 text-emerald-400">@mp.Type</span>
                </div>
                <div class="text-xs text-slate-500 flex items-center gap-3 mb-3">
                    <span>Grid Area: @mp.GridAreaCode</span>
                    <span>@_selectedAddress</span>
                </div>
                <div class="flex gap-2">
                    <button class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white text-xs font-semibold rounded-lg shadow-lg shadow-blue-500/20 transition-all duration-200"
                            @onclick="() => StartChangeOfSupplier(mp)">Change of Supplier</button>
                    <button class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white text-xs font-semibold rounded-lg shadow-lg shadow-blue-500/20 transition-all duration-200"
                            @onclick="() => StartAcontoChangeOfSupplier(mp)">Aconto CoS</button>
                    <button class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white text-xs font-semibold rounded-lg shadow-lg shadow-blue-500/20 transition-all duration-200"
                            @onclick="() => StartMoveIn(mp)">Move In</button>
                </div>
            </div>
        }
    </div>
}

<!-- Action List -->
@if (_actions.Count > 0)
{
    <h2 class="text-lg font-semibold text-white mb-4">Actions</h2>
    <div class="flex flex-col gap-3 mb-6">
        @foreach (var action in _actions)
        {
            var borderCss = action.Status switch
            {
                ActionStatus.Running => "border-l-amber-400",
                ActionStatus.WaitingForDate => "border-l-blue-500",
                ActionStatus.Completed => "border-l-emerald-400",
                ActionStatus.Failed => "border-l-rose-400",
                _ => "border-l-slate-600",
            };
            var isExpanded = _expandedActionId == action.Id;
            <div class="relative bg-white/[0.03] backdrop-blur-sm border border-white/[0.06] border-l-2 @borderCss rounded-xl p-4 flex flex-wrap">
                <!-- Action Row (clickable header) -->
                <div class="flex items-center gap-3 w-full cursor-pointer" @onclick="@(() => ToggleExpandAsync(action))">
                    <div class="text-xs font-mono font-bold text-slate-600 tabular-nums w-8 flex-shrink-0">#@action.Id</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-sm text-white">@action.Gsrn</span>
                            @if (action.CompletedOps.Count > 0)
                            {
                                @foreach (var op in action.CompletedOps)
                                {
                                    <span class="inline-block px-1.5 py-0.5 text-[0.6rem] font-semibold rounded bg-white/[0.05] text-slate-500 whitespace-nowrap">@op</span>
                                }
                            }
                        </div>
                        <div class="text-xs mt-0.5 whitespace-nowrap overflow-hidden text-ellipsis @(action.Status == ActionStatus.Failed ? "text-rose-400" : "text-slate-500")">
                            @if (action.Status == ActionStatus.Failed && action.ErrorMessage is not null)
                            {
                                <span>@action.ErrorMessage</span>
                            }
                            else if (action.Status == ActionStatus.Running)
                            {
                                <span>@action.ActionType — @action.CurrentStepDetails</span>
                            }
                            else if (action.Status == ActionStatus.WaitingForDate && action.MeteringDaysDelivered > 0 && action.MeteringDaysDelivered < action.TotalMeteringDays)
                            {
                                <span>@action.ActionType — RSM-012: @action.MeteringDaysDelivered/@action.TotalMeteringDays days received</span>
                            }
                            else if (action.Status == ActionStatus.WaitingForDate)
                            {
                                <span>@action.ActionType — waiting for @action.NextEventDate?.ToString("dd MMM"): @action.NextEventName</span>
                            }
                            else if (action.Result is not null)
                            {
                                @action.Result
                            }
                            else
                            {
                                @action.Address
                            }
                        </div>
                    </div>
                    <div class="flex items-center gap-3 flex-shrink-0">
                        @switch (action.Status)
                        {
                            case ActionStatus.Running:
                                <span class="inline-block px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide rounded-md bg-amber-500/15 text-amber-400">@action.CurrentStepName (@action.CompletedSteps/@action.TotalSteps)</span>
                                break;
                            case ActionStatus.WaitingForDate:
                                <span class="inline-block px-2.5 py-0.5 text-[0.65rem] font-semibold rounded-md bg-blue-500 text-white">@action.CompletedSteps/@action.TotalSteps</span>
                                break;
                            case ActionStatus.Completed:
                                <span class="inline-block px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide rounded-md bg-emerald-500/15 text-emerald-400">ready</span>
                                @if (!action.IsOffboarded)
                                {
                                    <div class="flex gap-1 ml-2">
                                        <button class="px-2 py-1 text-[0.65rem] font-semibold border border-white/[0.08] rounded bg-white/[0.03] text-slate-300 hover:bg-white/[0.06] hover:border-blue-500/40 transition-all duration-150 whitespace-nowrap"
                                                @onclick="@(() => StartFollowUp(action, "Receive Metering", 2))" @onclick:stopPropagation="true">Metering</button>
                                        <button class="px-2 py-1 text-[0.65rem] font-semibold border border-white/[0.08] rounded bg-white/[0.03] text-slate-300 hover:bg-white/[0.06] hover:border-blue-500/40 transition-all duration-150 whitespace-nowrap"
                                                @onclick="@(() => StartFollowUp(action, "Run Settlement", 3))" @onclick:stopPropagation="true">Settlement</button>
                                        <button class="px-2 py-1 text-[0.65rem] font-semibold border border-white/[0.08] rounded bg-white/[0.03] text-slate-300 hover:bg-white/[0.06] hover:border-blue-500/40 transition-all duration-150 whitespace-nowrap"
                                                @onclick="@(() => StartFollowUp(action, "Aconto Billing", 4))" @onclick:stopPropagation="true">Aconto</button>
                                        <button class="px-2 py-1 text-[0.65rem] font-semibold border border-white/[0.08] rounded bg-white/[0.03] text-rose-400 hover:bg-rose-500/10 hover:border-rose-500/40 transition-all duration-150 whitespace-nowrap"
                                                @onclick="@(() => StartFollowUp(action, "Offboard", 5))" @onclick:stopPropagation="true">Offboard</button>
                                        <button class="px-2 py-1 text-[0.65rem] font-semibold border border-white/[0.08] rounded bg-white/[0.03] text-rose-400 hover:bg-rose-500/10 hover:border-rose-500/40 transition-all duration-150 whitespace-nowrap"
                                                @onclick="@(() => StartFollowUp(action, "Move Out", 6))" @onclick:stopPropagation="true">Move Out</button>
                                    </div>
                                }
                                else
                                {
                                    <span class="inline-block px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide rounded-md bg-rose-500/15 text-rose-400">offboarded</span>
                                }
                                break;
                            case ActionStatus.Failed:
                                <span class="inline-block px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide rounded-md bg-rose-500/15 text-rose-400">failed</span>
                                break;
                        }
                        <span class="text-[0.55rem] text-slate-600 ml-1">@(isExpanded ? "\u25B2" : "\u25BC")</span>
                    </div>
                </div>

                <!-- Timeline Strip -->
                @if (action.TimelineEvents is { Count: > 0 })
                {
                    <div class="flex items-start w-full py-2 pl-2 overflow-x-auto">
                        @foreach (var evt in action.TimelineEvents)
                        {
                            var isRsm012Daily = evt.Name == "RSM-012 Daily";
                            var isRsm012Done = isRsm012Daily && action.MeteringDaysDelivered >= action.TotalMeteringDays && action.TotalMeteringDays > 0;
                            var isRsm012InProgress = isRsm012Daily && action.MeteringDaysDelivered > 0 && !isRsm012Done;
                            var dotColorCss = (isRsm012Done || (action.CompletedTimelineSteps.Contains(evt.Name) && evt.Date <= Clock.CurrentDate))
                                ? "bg-emerald-400 border-emerald-400"
                                : isRsm012InProgress
                                    ? "bg-amber-400 border-amber-400"
                                    : evt.Date <= Clock.CurrentDate && !isRsm012Daily
                                        ? "bg-blue-400 border-blue-400 animate-pulse-dot"
                                        : "bg-slate-700 border-slate-700";
                            <div class="tl-event flex flex-col items-center flex-1 min-w-[5rem] relative">
                                <div class="w-2.5 h-2.5 rounded-full border-2 z-10 flex-shrink-0 @dotColorCss"></div>
                                <div class="flex flex-col items-center mt-1 text-center">
                                    <span class="font-mono text-[0.62rem] font-semibold text-slate-600 tabular-nums">@evt.Date.ToString("dd MMM")</span>
                                    @if (isRsm012Daily && action.TotalMeteringDays > 0)
                                    {
                                        <span class="text-[0.58rem] text-slate-600 whitespace-nowrap cursor-pointer hover:text-blue-400 hover:underline transition-colors duration-150"
                                              @onclick="() => ShowCimJsonAsync(action, evt)"
                                              @onclick:stopPropagation="true">RSM-012</span>
                                        <div class="w-12 h-[3px] bg-slate-700 rounded-sm mt-0.5 overflow-hidden">
                                            <div class="h-full bg-emerald-400 rounded-sm transition-all duration-300" style="width: @(action.TotalMeteringDays > 0 ? (int)(100.0 * action.MeteringDaysDelivered / action.TotalMeteringDays) : 0)%"></div>
                                        </div>
                                        <span class="font-mono text-[0.62rem] font-semibold text-white tabular-nums mt-0.5">@action.MeteringDaysDelivered / @action.TotalMeteringDays</span>
                                    }
                                    else
                                    {
                                        <span class="text-[0.58rem] text-slate-600 whitespace-nowrap cursor-pointer hover:text-blue-400 hover:underline transition-colors duration-150"
                                              @onclick="() => ShowCimJsonAsync(action, evt)"
                                              @onclick:stopPropagation="true">@evt.Name</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }

                <!-- Expanded Detail Panel -->
                @if (isExpanded && action.Summary is { } summary)
                {
                    <div class="w-full border-t border-white/[0.04] mt-3 pt-3 flex flex-col gap-3">
                        <!-- Metering Point -->
                        <div class="flex flex-col gap-0.5">
                            <div class="text-[0.65rem] font-bold uppercase tracking-wider text-slate-600 pl-2">Metering Point</div>
                            <div class="flex items-baseline gap-4 text-xs px-2 py-1 rounded bg-white/[0.03]">
                                <span class="text-slate-300">Status: <strong class="text-white">@summary.ConnectionStatus</strong></span>
                                @if (summary.ActivatedAt.HasValue)
                                {
                                    <span class="text-slate-500">Activated: @summary.ActivatedAt.Value.ToString("yyyy-MM-dd HH:mm")</span>
                                }
                                @if (summary.DeactivatedAt.HasValue)
                                {
                                    <span class="text-slate-500">Deactivated: @summary.DeactivatedAt.Value.ToString("yyyy-MM-dd HH:mm")</span>
                                }
                            </div>
                        </div>

                        <!-- Processes -->
                        @if (summary.Processes.Count > 0)
                        {
                            <div class="flex flex-col gap-0.5">
                                <div class="text-[0.65rem] font-bold uppercase tracking-wider text-slate-600 pl-2">Processes</div>
                                @foreach (var p in summary.Processes)
                                {
                                    var pBadgeCss = p.Status == "completed" ? "bg-emerald-500/15 text-emerald-400"
                                                  : p.Status == "final_settled" ? "bg-rose-500/15 text-rose-400"
                                                  : "bg-amber-500/15 text-amber-400";
                                    <div class="flex items-baseline gap-4 text-xs px-2 py-1 rounded bg-white/[0.03]">
                                        <span class="font-semibold text-white min-w-[8rem]">@p.ProcessType</span>
                                        <span class="inline-block px-1.5 py-0.5 text-[0.6rem] font-semibold uppercase tracking-wide rounded @pBadgeCss">@p.Status</span>
                                        @if (p.EffectiveDate.HasValue)
                                        {
                                            <span class="text-slate-500">from @p.EffectiveDate.Value</span>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        <!-- Supply Periods -->
                        @if (summary.SupplyPeriods.Count > 0)
                        {
                            <div class="flex flex-col gap-0.5">
                                <div class="text-[0.65rem] font-bold uppercase tracking-wider text-slate-600 pl-2">Supply Periods</div>
                                @foreach (var sp in summary.SupplyPeriods)
                                {
                                    <div class="flex items-baseline gap-4 text-xs px-2 py-1 rounded bg-white/[0.03]">
                                        <span class="text-slate-300">@sp.StartDate &rarr; @(sp.EndDate?.ToString() ?? "ongoing")</span>
                                        @if (sp.EndReason is not null)
                                        {
                                            <span class="text-slate-600 text-[0.7rem]">(@sp.EndReason)</span>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        <!-- Metering Data -->
                        @if (summary.Metering is { } m)
                        {
                            <div class="flex flex-col gap-0.5">
                                <div class="text-[0.65rem] font-bold uppercase tracking-wider text-slate-600 pl-2">Metering Data</div>
                                <div class="flex items-baseline gap-4 text-xs px-2 py-1 rounded bg-white/[0.03]">
                                    <span class="text-slate-300">@m.ReadingCount readings</span>
                                    <span class="text-slate-300">@m.TotalKwh.ToString("N1") kWh</span>
                                    <span class="text-slate-600 text-[0.7rem]">@m.FirstReading.ToString("yyyy-MM-dd") &ndash; @m.LastReading.ToString("yyyy-MM-dd")</span>
                                </div>
                            </div>
                        }

                        <!-- Settlements -->
                        @if (summary.Settlements.Count > 0)
                        {
                            <div class="flex flex-col gap-0.5">
                                <div class="text-[0.65rem] font-bold uppercase tracking-wider text-slate-600 pl-2">Settlements</div>
                                @foreach (var s in summary.Settlements)
                                {
                                    <div class="flex items-baseline gap-4 text-xs px-2 py-1 rounded bg-white/[0.03]">
                                        <span class="text-slate-300">@s.PeriodStart &rarr; @s.PeriodEnd</span>
                                        <span class="text-white font-bold">@s.TotalAmount.ToString("N2") DKK</span>
                                        <span class="text-slate-600 text-[0.7rem]">VAT @s.VatAmount.ToString("N2")</span>
                                        <span class="inline-block px-1.5 py-0.5 text-[0.6rem] font-semibold uppercase tracking-wide rounded bg-emerald-500/15 text-emerald-400">@s.Status</span>
                                    </div>
                                }
                            </div>
                        }

                        <!-- Aconto Payments -->
                        @if (summary.AcontoPayments.Count > 0)
                        {
                            <div class="flex flex-col gap-0.5">
                                <div class="text-[0.65rem] font-bold uppercase tracking-wider text-slate-600 pl-2">Aconto Payments</div>
                                @foreach (var a in summary.AcontoPayments)
                                {
                                    <div class="flex items-baseline gap-4 text-xs px-2 py-1 rounded bg-white/[0.03]">
                                        <span class="text-slate-300">@a.PeriodStart &rarr; @a.PeriodEnd</span>
                                        <span class="text-white font-bold">@a.Amount.ToString("N2") DKK</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else if (isExpanded && action.Summary is null)
                {
                    <div class="w-full border-t border-white/[0.04] mt-3 pt-3">
                        <span class="text-xs text-slate-600">Loading...</span>
                    </div>
                }
            </div>
        }
    </div>
}

<!-- CIM JSON Modal -->
@if (_cimJsonContent is not null)
{
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center" @onclick="CloseCimJson">
        <div class="bg-slate-900 border border-white/[0.08] rounded-xl max-w-3xl w-[92%] max-h-[82vh] flex flex-col shadow-2xl shadow-black/40" @onclick:stopPropagation="true">
            <div class="flex items-center justify-between px-5 py-3.5 border-b border-white/[0.06] flex-shrink-0">
                <span class="font-bold text-sm text-white">@_cimJsonStepName</span>
                <button class="text-slate-500 hover:text-white text-xl leading-none transition-colors duration-150" @onclick="CloseCimJson">&times;</button>
            </div>
            <pre class="m-0 px-5 py-4 overflow-y-auto text-xs leading-relaxed whitespace-pre-wrap break-words font-mono text-slate-300 bg-slate-950 rounded-b-xl">@_cimJsonContent</pre>
        </div>
    </div>
}

@code {
    private enum ActionStatus { Pending, Running, WaitingForDate, Completed, Failed }

    private sealed class ActionViewModel
    {
        public int Id { get; init; }
        public string Gsrn { get; init; } = "";
        public string Address { get; init; } = "";
        public string ActionType { get; set; } = "";
        public int TotalSteps { get; set; } = 7;
        public bool IsOffboarded { get; set; }
        public ActionStatus Status { get; set; }
        public int CompletedSteps { get; set; }
        public string? CurrentStepName { get; set; }
        public string? CurrentStepDetails { get; set; }
        public string? Result { get; set; }
        public string? ErrorMessage { get; set; }
        public List<string> CompletedOps { get; } = new();
        public MeteringPointSummary? Summary { get; set; }

        // Time-aware fields
        public bool IsTimeAware { get; set; }
        public ChangeOfSupplierContext? CosContext { get; set; }
        public MoveInContext? MoveInContext { get; set; }
        public AcontoChangeOfSupplierContext? AcontoCoSContext { get; set; }
        public IReadOnlyList<TimelineEvent>? TimelineEvents { get; set; }
        public HashSet<string> CompletedTimelineSteps { get; } = new();
        public string? NextEventName { get; set; }
        public DateOnly? NextEventDate { get; set; }

        // Metering progress
        public int MeteringDaysDelivered { get; set; }
        public int TotalMeteringDays { get; set; }
    }

    private record DawaSuggestion(string Text, string DarId);

    private string? _cimJsonContent;
    private string? _cimJsonStepName;

    private string _searchQuery = "";
    private bool _searching;
    private bool _resetting;
    private bool _ticking;
    private bool _addressSelected;
    private string _selectedAddress = "";
    private int? _expandedActionId;
    private readonly List<DawaSuggestion> _suggestions = new();
    private readonly List<MeteringPointInfo> _selectedMeteringPoints = new();
    private readonly List<ActionViewModel> _actions = new();
    private int _actionCounter;
    private Timer? _debounceTimer;

    private async Task ResetDatabaseAsync()
    {
        _resetting = true;
        StateHasChanged();

        await Simulator.ResetAsync();
        Clock.Reset();

        _actions.Clear();
        _expandedActionId = null;
        _resetting = false;
        StateHasChanged();
    }

    private async Task AdvanceOneDayAsync()
    {
        Clock.AdvanceDays(1);
        await TickAllActionsAsync();
    }

    private async Task AdvanceSevenDaysAsync()
    {
        Clock.AdvanceDays(7);
        await TickAllActionsAsync();
    }

    private async Task SkipToNextEventAsync()
    {
        // Find the earliest future event across all time-aware actions
        DateOnly? earliest = null;
        foreach (var action in _actions.Where(a => a.IsTimeAware && a.Status == ActionStatus.WaitingForDate))
        {
            var timeline = action.CosContext?.Timeline ?? action.MoveInContext?.Timeline ?? action.AcontoCoSContext?.Timeline;
            if (timeline is null) continue;

            var nextEvt = timeline.Events
                .Where(e => e.Date > Clock.CurrentDate && !action.CompletedTimelineSteps.Contains(e.Name))
                .OrderBy(e => e.Date)
                .FirstOrDefault();

            if (nextEvt is not null && (earliest is null || nextEvt.Date < earliest))
                earliest = nextEvt.Date;
        }

        if (earliest is not null)
        {
            Clock.AdvanceTo(earliest.Value);
            await TickAllActionsAsync();
        }
    }

    private async Task TickAllActionsAsync()
    {
        _ticking = true;
        StateHasChanged();

        foreach (var action in _actions.Where(a => a.IsTimeAware && a.Status == ActionStatus.WaitingForDate))
        {
            try
            {
                List<SimulationStep> executed;
                if (action.CosContext is { } cosCtx)
                {
                    executed = await Simulator.TickChangeOfSupplierAsync(cosCtx, Clock.CurrentDate, CancellationToken.None);
                }
                else if (action.MoveInContext is { } miCtx)
                {
                    executed = await Simulator.TickMoveInAsync(miCtx, Clock.CurrentDate, CancellationToken.None);
                }
                else if (action.AcontoCoSContext is { } acontoCtx)
                {
                    executed = await Simulator.TickAcontoChangeOfSupplierAsync(acontoCtx, Clock.CurrentDate, CancellationToken.None);
                }
                else continue;

                foreach (var step in executed)
                {
                    action.CompletedSteps = step.Number;
                    action.CurrentStepName = step.Name;
                    action.CurrentStepDetails = step.Details;
                    if (step.Name == "Receive RSM-012")
                    {
                        SyncMeteringProgress(action);
                        if (action.MeteringDaysDelivered > 0)
                            action.CompletedTimelineSteps.Add("RSM-012 Daily");
                    }
                    else
                    {
                        action.CompletedTimelineSteps.Add(step.Name);
                    }
                }

                // Check if all steps done
                var isComplete = action.AcontoCoSContext is not null
                    ? action.AcontoCoSContext.IsAcontoSettled
                    : action.CosContext is not null
                        ? action.CosContext.IsSettled
                        : action.MoveInContext?.IsSettled ?? false;

                if (isComplete)
                {
                    action.Status = ActionStatus.Completed;
                    action.CompletedOps.Add(action.ActionType);
                    action.Result = action.CurrentStepDetails;
                }
                else
                {
                    UpdateNextEvent(action);
                }
            }
            catch (Exception ex)
            {
                action.Status = ActionStatus.Failed;
                action.ErrorMessage = ex.Message;
            }
        }

        _ticking = false;
        StateHasChanged();
    }

    private static void SyncMeteringProgress(ActionViewModel action)
    {
        if (action.CosContext is { } cos)
        {
            action.MeteringDaysDelivered = cos.MeteringDaysDelivered;
            action.TotalMeteringDays = cos.TotalMeteringDays;
        }
        else if (action.MoveInContext is { } mi)
        {
            action.MeteringDaysDelivered = mi.MeteringDaysDelivered;
            action.TotalMeteringDays = mi.TotalMeteringDays;
        }
        else if (action.AcontoCoSContext is { } aconto)
        {
            action.MeteringDaysDelivered = aconto.MeteringDaysDelivered;
            action.TotalMeteringDays = aconto.TotalMeteringDays;
        }
    }

    private void UpdateNextEvent(ActionViewModel action)
    {
        var timeline = action.CosContext?.Timeline ?? action.MoveInContext?.Timeline ?? action.AcontoCoSContext?.Timeline;
        if (timeline is null) return;

        var nextEvt = timeline.Events
            .Where(e => !action.CompletedTimelineSteps.Contains(e.Name))
            .OrderBy(e => e.Date)
            .FirstOrDefault();

        action.NextEventName = nextEvt?.Name;
        action.NextEventDate = nextEvt?.Date;
    }

    private async Task ToggleExpandAsync(ActionViewModel action)
    {
        if (_expandedActionId == action.Id)
        {
            _expandedActionId = null;
            return;
        }

        _expandedActionId = action.Id;
        action.Summary = null;
        StateHasChanged();

        action.Summary = await Simulator.GetMeteringPointSummaryAsync(action.Gsrn, CancellationToken.None);
        StateHasChanged();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _searchQuery = e.Value?.ToString() ?? "";
        _addressSelected = false;
        _debounceTimer?.Dispose();
        if (_searchQuery.Length < 2)
        {
            _suggestions.Clear();
            return;
        }
        var query = _searchQuery;
        _debounceTimer = new Timer(_ => InvokeAsync(() => SearchAddressAsync(query)), null, 300, Timeout.Infinite);
    }

    private async Task SearchAddressAsync(string query)
    {
        _searching = true;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient();
            var url = $"https://api.dataforsyningen.dk/adresser/autocomplete?q={Uri.EscapeDataString(query)}";
            var response = await client.GetStringAsync(url);
            var items = JsonSerializer.Deserialize<JsonElement[]>(response) ?? [];

            _suggestions.Clear();
            foreach (var item in items.Take(8))
            {
                var text = item.GetProperty("tekst").GetString() ?? "";
                var darId = item.GetProperty("adresse").GetProperty("id").GetString() ?? "";
                _suggestions.Add(new DawaSuggestion(text, darId));
            }
        }
        catch
        {
            _suggestions.Clear();
        }
        finally
        {
            _searching = false;
            StateHasChanged();
        }
    }

    private async Task SelectAddress(DawaSuggestion suggestion)
    {
        _searchQuery = suggestion.Text;
        _selectedAddress = suggestion.Text;
        _addressSelected = true;
        _suggestions.Clear();
        _selectedMeteringPoints.Clear();

        var result = await AddressLookup.LookupByDarIdAsync(suggestion.DarId, CancellationToken.None);
        _selectedMeteringPoints.AddRange(result.MeteringPoints);
        StateHasChanged();
    }

    private DateOnly ComputeEffectiveDate()
    {
        var today = Clock.CurrentDate;
        // Effective date = first of next month (or current month if today is already the 1st)
        var effective = today.Day == 1
            ? today
            : new DateOnly(today.Year, today.Month, 1).AddMonths(1);
        return effective;
    }

    private async Task StartChangeOfSupplier(MeteringPointInfo mp)
    {
        var actionId = Interlocked.Increment(ref _actionCounter);
        var effectiveDate = ComputeEffectiveDate();
        var cosCtx = new ChangeOfSupplierContext(mp.Gsrn, $"Customer #{actionId}", effectiveDate);

        var action = new ActionViewModel
        {
            Id = actionId,
            Gsrn = mp.Gsrn,
            Address = _selectedAddress,
            ActionType = "Change of Supplier",
            TotalSteps = 7,
            Status = ActionStatus.WaitingForDate,
            IsTimeAware = true,
            CosContext = cosCtx,
            TimelineEvents = cosCtx.Timeline.Events,
            TotalMeteringDays = cosCtx.TotalMeteringDays,
        };
        UpdateNextEvent(action);
        _actions.Insert(0, action);

        _selectedMeteringPoints.Clear();
        _searchQuery = "";
        _addressSelected = false;

        // Execute any steps already due at the current clock date
        await TickSingleActionAsync(action);
        StateHasChanged();
    }

    private async Task StartMoveIn(MeteringPointInfo mp)
    {
        var actionId = Interlocked.Increment(ref _actionCounter);
        var effectiveDate = ComputeEffectiveDate();
        var miCtx = new MoveInContext(mp.Gsrn, $"Customer #{actionId}", effectiveDate);

        var action = new ActionViewModel
        {
            Id = actionId,
            Gsrn = mp.Gsrn,
            Address = _selectedAddress,
            ActionType = "Move In",
            TotalSteps = 7,
            Status = ActionStatus.WaitingForDate,
            IsTimeAware = true,
            MoveInContext = miCtx,
            TimelineEvents = miCtx.Timeline.Events,
            TotalMeteringDays = miCtx.TotalMeteringDays,
        };
        UpdateNextEvent(action);
        _actions.Insert(0, action);

        _selectedMeteringPoints.Clear();
        _searchQuery = "";
        _addressSelected = false;

        await TickSingleActionAsync(action);
        StateHasChanged();
    }

    private async Task StartAcontoChangeOfSupplier(MeteringPointInfo mp)
    {
        var actionId = Interlocked.Increment(ref _actionCounter);
        var effectiveDate = ComputeEffectiveDate();
        var acontoCtx = new AcontoChangeOfSupplierContext(mp.Gsrn, $"Customer #{actionId}", effectiveDate);

        var action = new ActionViewModel
        {
            Id = actionId,
            Gsrn = mp.Gsrn,
            Address = _selectedAddress,
            ActionType = "Aconto CoS",
            TotalSteps = 10,
            Status = ActionStatus.WaitingForDate,
            IsTimeAware = true,
            AcontoCoSContext = acontoCtx,
            TimelineEvents = acontoCtx.Timeline.Events,
            TotalMeteringDays = acontoCtx.TotalMeteringDays,
        };
        UpdateNextEvent(action);
        _actions.Insert(0, action);

        _selectedMeteringPoints.Clear();
        _searchQuery = "";
        _addressSelected = false;

        await TickSingleActionAsync(action);
        StateHasChanged();
    }

    private async Task TickSingleActionAsync(ActionViewModel action)
    {
        try
        {
            List<SimulationStep> executed;
            if (action.CosContext is { } cosCtx)
                executed = await Simulator.TickChangeOfSupplierAsync(cosCtx, Clock.CurrentDate, CancellationToken.None);
            else if (action.MoveInContext is { } miCtx)
                executed = await Simulator.TickMoveInAsync(miCtx, Clock.CurrentDate, CancellationToken.None);
            else if (action.AcontoCoSContext is { } acontoCtx)
                executed = await Simulator.TickAcontoChangeOfSupplierAsync(acontoCtx, Clock.CurrentDate, CancellationToken.None);
            else return;

            foreach (var step in executed)
            {
                action.CompletedSteps = step.Number;
                action.CurrentStepName = step.Name;
                action.CurrentStepDetails = step.Details;
                if (step.Name == "Receive RSM-012")
                {
                    SyncMeteringProgress(action);
                    if (action.MeteringDaysDelivered > 0)
                        action.CompletedTimelineSteps.Add("RSM-012 Daily");
                }
                else
                {
                    action.CompletedTimelineSteps.Add(step.Name);
                }
            }

            var isComplete = action.AcontoCoSContext is not null
                ? action.AcontoCoSContext.IsAcontoSettled
                : action.CosContext?.IsSettled ?? action.MoveInContext?.IsSettled ?? false;
            if (isComplete)
            {
                action.Status = ActionStatus.Completed;
                action.CompletedOps.Add(action.ActionType);
                action.Result = action.CurrentStepDetails;
            }
            else
            {
                UpdateNextEvent(action);
            }
        }
        catch (Exception ex)
        {
            action.Status = ActionStatus.Failed;
            action.ErrorMessage = ex.Message;
        }
    }

    private void StartFollowUp(ActionViewModel action, string actionType, int totalSteps)
    {
        action.ActionType = actionType;
        action.TotalSteps = totalSteps;
        action.Status = ActionStatus.Running;
        action.CompletedSteps = 0;
        action.CurrentStepName = "Starting...";
        action.CurrentStepDetails = null;
        action.Result = null;
        action.ErrorMessage = null;
        action.IsTimeAware = false;

        _ = RunActionAsync(action);
    }

    private async Task RunActionAsync(ActionViewModel action)
    {
        try
        {
            var stepCallback = new Func<SimulationStep, Task>(async step =>
            {
                await InvokeAsync(() =>
                {
                    action.CompletedSteps = step.Number;
                    action.CurrentStepName = step.Name;
                    action.CurrentStepDetails = step.Details;

                    if (step.Number == action.TotalSteps && step.Details is not null)
                        action.Result = step.Details;

                    StateHasChanged();
                });
            });

            switch (action.ActionType)
            {
                case "Receive Metering":
                    await Simulator.ReceiveMeteringOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Run Settlement":
                    await Simulator.RunSettlementOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Offboard":
                    await Simulator.OffboardOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Aconto Billing":
                    await Simulator.AcontoBillingOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Move Out":
                    await Simulator.RunMoveOutAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
            }

            await InvokeAsync(() =>
            {
                action.CompletedOps.Add(action.ActionType);
                action.Status = ActionStatus.Completed;
                if (action.ActionType is "Offboard" or "Move Out")
                    action.IsOffboarded = true;
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                action.Status = ActionStatus.Failed;
                action.ErrorMessage = ex.Message;
                StateHasChanged();
            });
        }
    }

    private async Task ShowCimJsonAsync(ActionViewModel action, TimelineEvent evt)
    {
        var gsrn = action.Gsrn;
        var effectiveDate = action.CosContext?.EffectiveDate
                            ?? action.MoveInContext?.EffectiveDate
                            ?? action.AcontoCoSContext?.EffectiveDate
                            ?? DateOnly.FromDateTime(DateTime.UtcNow);

        // Try to get real stored message first, fall back to example
        var json = await Simulator.GetMessageAuditAsync(gsrn, evt.Name, CancellationToken.None)
                   ?? CimMessageBuilder.BuildExampleMessage(evt.Name, gsrn, effectiveDate);
        if (json is null) return;

        _cimJsonStepName = evt.Name;
        _cimJsonContent = json;
    }

    private void CloseCimJson()
    {
        _cimJsonContent = null;
        _cimJsonStepName = null;
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
