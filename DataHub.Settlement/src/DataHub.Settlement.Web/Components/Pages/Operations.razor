@page "/operations"
@using System.Text.Json
@using DataHub.Settlement.Application.AddressLookup
@using DataHub.Settlement.Infrastructure.Dashboard
@inject IAddressLookupClient AddressLookup
@inject SimulationService Simulator
@inject IHttpClientFactory HttpClientFactory

<div style="display: flex; align-items: center; justify-content: space-between;">
    <h1>Operations</h1>
    <button class="ops-reset-btn" @onclick="ResetDatabaseAsync" disabled="@_resetting">
        @(_resetting ? "Resetting..." : "Reset Database")
    </button>
</div>
<p style="color: var(--text-muted); margin-bottom: 1.5rem;">
    Search an address, find metering points, and run concurrent change-of-supplier actions.
</p>

<!-- Address Search -->
<div class="ops-search-section">
    <div class="ops-search-wrapper">
        <input type="text"
               class="ops-search-input"
               placeholder="Search Danish address (e.g. Rendsburggade 1)..."
               value="@_searchQuery"
               @oninput="OnSearchInput" />
        @if (_suggestions.Count > 0 && !_addressSelected)
        {
            <div class="ops-suggestions">
                @foreach (var s in _suggestions)
                {
                    <div class="ops-suggestion" @onclick="() => SelectAddress(s)">@s.Text</div>
                }
            </div>
        }
    </div>
    @if (_searching)
    {
        <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 0.5rem;">Searching...</span>
    }
</div>

<!-- Metering Point Card -->
@if (_selectedMeteringPoints.Count > 0)
{
    <div class="ops-mp-cards">
        @foreach (var mp in _selectedMeteringPoints)
        {
            <div class="ops-mp-card">
                <div class="ops-mp-header">
                    <span class="ops-mp-gsrn">@mp.Gsrn</span>
                    <span class="badge badge-completed">@mp.Type</span>
                </div>
                <div class="ops-mp-details">
                    <span>Grid Area: @mp.GridAreaCode</span>
                    <span>@_selectedAddress</span>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                    <button class="btn" @onclick="() => StartChangeOfSupplier(mp)">
                        Change of Supplier
                    </button>
                    <button class="btn" @onclick="() => StartMoveIn(mp)">
                        Move In
                    </button>
                </div>
            </div>
        }
    </div>
}

<!-- Action List -->
@if (_actions.Count > 0)
{
    <h2 style="margin-top: 2rem; font-size: 1.1rem; font-weight: 600;">Actions</h2>
    <div class="ops-action-list">
        @foreach (var action in _actions)
        {
            var rowCss = action.Status switch
            {
                ActionStatus.Running => "ops-action ops-action-running",
                ActionStatus.Completed => "ops-action ops-action-completed",
                ActionStatus.Failed => "ops-action ops-action-failed",
                _ => "ops-action",
            };
            var isExpanded = _expandedActionId == action.Id;
            <div class="@rowCss" style="flex-wrap: wrap;">
                <div class="ops-action-row" @onclick="@(() => ToggleExpandAsync(action))">
                    <div class="ops-action-id">#@action.Id</div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-weight: 600; font-size: 0.95rem;">@action.Gsrn</span>
                            @if (action.CompletedOps.Count > 0)
                            {
                                @foreach (var op in action.CompletedOps)
                                {
                                    <span class="ops-history-badge">@op</span>
                                }
                            }
                        </div>
                        <div style="font-size: 0.8rem; color: @(action.Status == ActionStatus.Failed ? "var(--red)" : "var(--text-muted)"); margin-top: 0.15rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            @if (action.Status == ActionStatus.Failed && action.ErrorMessage is not null)
                            {
                                <span>@action.ErrorMessage</span>
                            }
                            else if (action.Status == ActionStatus.Running)
                            {
                                <span>@action.ActionType â€” @action.CurrentStepDetails</span>
                            }
                            else if (action.Result is not null)
                            {
                                @action.Result
                            }
                            else
                            {
                                @action.Address
                            }
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0;">
                        @switch (action.Status)
                        {
                            case ActionStatus.Running:
                                <span class="badge badge-sent">@action.CurrentStepName (@action.CompletedSteps/@action.TotalSteps)</span>
                                break;
                            case ActionStatus.Completed:
                                <span class="badge badge-completed">ready</span>
                                @if (!action.IsOffboarded)
                                {
                                    <div class="ops-followup">
                                        <button class="ops-followup-btn" @onclick="@(() => StartFollowUp(action, "Receive Metering", 2))" @onclick:stopPropagation="true">Metering</button>
                                        <button class="ops-followup-btn" @onclick="@(() => StartFollowUp(action, "Run Settlement", 3))" @onclick:stopPropagation="true">Settlement</button>
                                        <button class="ops-followup-btn" @onclick="@(() => StartFollowUp(action, "Aconto Billing", 4))" @onclick:stopPropagation="true">Aconto</button>
                                        <button class="ops-followup-btn ops-followup-btn-warn" @onclick="@(() => StartFollowUp(action, "Offboard", 5))" @onclick:stopPropagation="true">Offboard</button>
                                        <button class="ops-followup-btn ops-followup-btn-warn" @onclick="@(() => StartFollowUp(action, "Move Out", 6))" @onclick:stopPropagation="true">Move Out</button>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge badge-dead-letter">offboarded</span>
                                }
                                break;
                            case ActionStatus.Failed:
                                <span class="badge badge-dead-letter">failed</span>
                                break;
                        }
                        <span class="ops-expand-icon">@(isExpanded ? "\u25B2" : "\u25BC")</span>
                    </div>
                </div>
                @if (isExpanded && action.Summary is { } summary)
                {
                    <div class="ops-detail-panel">
                        <!-- Metering Point -->
                        <div class="ops-detail-section">
                            <div class="ops-detail-label">Metering Point</div>
                            <div class="ops-detail-row">
                                <span>Status: <strong>@summary.ConnectionStatus</strong></span>
                                @if (summary.ActivatedAt.HasValue)
                                {
                                    <span>Activated: @summary.ActivatedAt.Value.ToString("yyyy-MM-dd HH:mm")</span>
                                }
                                @if (summary.DeactivatedAt.HasValue)
                                {
                                    <span>Deactivated: @summary.DeactivatedAt.Value.ToString("yyyy-MM-dd HH:mm")</span>
                                }
                            </div>
                        </div>

                        <!-- Processes -->
                        @if (summary.Processes.Count > 0)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Processes</div>
                                @foreach (var p in summary.Processes)
                                {
                                    <div class="ops-detail-row">
                                        <span class="ops-detail-tag">@p.ProcessType</span>
                                        <span class="badge @(p.Status == "completed" ? "badge-completed" : p.Status == "final_settled" ? "badge-dead-letter" : "badge-sent")">@p.Status</span>
                                        @if (p.EffectiveDate.HasValue)
                                        {
                                            <span>from @p.EffectiveDate.Value</span>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        <!-- Supply Periods -->
                        @if (summary.SupplyPeriods.Count > 0)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Supply Periods</div>
                                @foreach (var sp in summary.SupplyPeriods)
                                {
                                    <div class="ops-detail-row">
                                        <span>@sp.StartDate &rarr; @(sp.EndDate?.ToString() ?? "ongoing")</span>
                                        @if (sp.EndReason is not null)
                                        {
                                            <span class="ops-detail-muted">(@sp.EndReason)</span>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        <!-- Metering Data -->
                        @if (summary.Metering is { } m)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Metering Data</div>
                                <div class="ops-detail-row">
                                    <span>@m.ReadingCount readings</span>
                                    <span>@m.TotalKwh.ToString("N1") kWh</span>
                                    <span class="ops-detail-muted">@m.FirstReading.ToString("yyyy-MM-dd") &ndash; @m.LastReading.ToString("yyyy-MM-dd")</span>
                                </div>
                            </div>
                        }

                        <!-- Settlements -->
                        @if (summary.Settlements.Count > 0)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Settlements</div>
                                @foreach (var s in summary.Settlements)
                                {
                                    <div class="ops-detail-row">
                                        <span>@s.PeriodStart &rarr; @s.PeriodEnd</span>
                                        <span><strong>@s.TotalAmount.ToString("N2") DKK</strong></span>
                                        <span class="ops-detail-muted">VAT @s.VatAmount.ToString("N2")</span>
                                        <span class="badge badge-completed">@s.Status</span>
                                    </div>
                                }
                            </div>
                        }

                        <!-- Aconto Payments -->
                        @if (summary.AcontoPayments.Count > 0)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Aconto Payments</div>
                                @foreach (var a in summary.AcontoPayments)
                                {
                                    <div class="ops-detail-row">
                                        <span>@a.PeriodStart &rarr; @a.PeriodEnd</span>
                                        <span><strong>@a.Amount.ToString("N2") DKK</strong></span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else if (isExpanded && action.Summary is null)
                {
                    <div class="ops-detail-panel">
                        <span class="ops-detail-muted">Loading...</span>
                    </div>
                }
            </div>
        }
    </div>
}

<style>
    .ops-action-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        cursor: pointer;
    }

    .ops-expand-icon {
        font-size: 0.6rem;
        color: var(--text-muted);
        margin-left: 0.25rem;
    }

    .ops-followup {
        display: flex;
        gap: 0.35rem;
        margin-left: 0.5rem;
    }

    .ops-followup-btn {
        padding: 0.2rem 0.5rem;
        font-size: 0.72rem;
        font-weight: 600;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--bg-card);
        color: var(--text);
        cursor: pointer;
        white-space: nowrap;
        transition: background 0.15s, border-color 0.15s;
    }

    .ops-followup-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent);
    }

    .ops-followup-btn-warn:hover {
        border-color: var(--red);
        color: var(--red);
    }

    .ops-history-badge {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        font-size: 0.65rem;
        font-weight: 600;
        border-radius: 3px;
        background: var(--bg-hover);
        color: var(--text-muted);
        white-space: nowrap;
    }

    .ops-detail-panel {
        width: 100%;
        border-top: 1px solid var(--border);
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .ops-detail-section {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .ops-detail-label {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
    }

    .ops-detail-row {
        display: flex;
        align-items: baseline;
        gap: 0.75rem;
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        background: var(--bg-hover);
    }

    .ops-detail-tag {
        font-weight: 600;
        min-width: 8rem;
    }

    .ops-detail-muted {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .ops-reset-btn {
        padding: 0.35rem 0.75rem;
        font-size: 0.78rem;
        font-weight: 600;
        border: 1px solid var(--red);
        border-radius: 4px;
        background: transparent;
        color: var(--red);
        cursor: pointer;
        transition: background 0.15s;
    }

    .ops-reset-btn:hover:not(:disabled) {
        background: var(--red);
        color: #fff;
    }

    .ops-reset-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

@code {
    private enum ActionStatus { Pending, Running, Completed, Failed }

    private sealed class ActionViewModel
    {
        public int Id { get; init; }
        public string Gsrn { get; init; } = "";
        public string Address { get; init; } = "";
        public string ActionType { get; set; } = "";
        public int TotalSteps { get; set; } = 8;
        public bool IsOffboarded { get; set; }
        public ActionStatus Status { get; set; }
        public int CompletedSteps { get; set; }
        public string? CurrentStepName { get; set; }
        public string? CurrentStepDetails { get; set; }
        public string? Result { get; set; }
        public string? ErrorMessage { get; set; }
        public List<string> CompletedOps { get; } = new();
        public MeteringPointSummary? Summary { get; set; }
    }

    private record DawaSuggestion(string Text, string DarId);

    private string _searchQuery = "";
    private bool _searching;
    private bool _resetting;
    private bool _addressSelected;
    private string _selectedAddress = "";
    private int? _expandedActionId;
    private readonly List<DawaSuggestion> _suggestions = new();
    private readonly List<MeteringPointInfo> _selectedMeteringPoints = new();
    private readonly List<ActionViewModel> _actions = new();
    private int _actionCounter;
    private Timer? _debounceTimer;

    private async Task ResetDatabaseAsync()
    {
        _resetting = true;
        StateHasChanged();

        await Simulator.ResetAsync();

        _actions.Clear();
        _expandedActionId = null;
        _resetting = false;
        StateHasChanged();
    }

    private async Task ToggleExpandAsync(ActionViewModel action)
    {
        if (_expandedActionId == action.Id)
        {
            _expandedActionId = null;
            return;
        }

        _expandedActionId = action.Id;
        action.Summary = null;
        StateHasChanged();

        action.Summary = await Simulator.GetMeteringPointSummaryAsync(action.Gsrn, CancellationToken.None);
        StateHasChanged();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _searchQuery = e.Value?.ToString() ?? "";
        _addressSelected = false;
        _debounceTimer?.Dispose();
        if (_searchQuery.Length < 2)
        {
            _suggestions.Clear();
            return;
        }
        var query = _searchQuery;
        _debounceTimer = new Timer(_ => InvokeAsync(() => SearchAddressAsync(query)), null, 300, Timeout.Infinite);
    }

    private async Task SearchAddressAsync(string query)
    {
        _searching = true;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient();
            var url = $"https://api.dataforsyningen.dk/adresser/autocomplete?q={Uri.EscapeDataString(query)}";
            var response = await client.GetStringAsync(url);
            var items = JsonSerializer.Deserialize<JsonElement[]>(response) ?? [];

            _suggestions.Clear();
            foreach (var item in items.Take(8))
            {
                var text = item.GetProperty("tekst").GetString() ?? "";
                var darId = item.GetProperty("adresse").GetProperty("id").GetString() ?? "";
                _suggestions.Add(new DawaSuggestion(text, darId));
            }
        }
        catch
        {
            _suggestions.Clear();
        }
        finally
        {
            _searching = false;
            StateHasChanged();
        }
    }

    private async Task SelectAddress(DawaSuggestion suggestion)
    {
        _searchQuery = suggestion.Text;
        _selectedAddress = suggestion.Text;
        _addressSelected = true;
        _suggestions.Clear();
        _selectedMeteringPoints.Clear();

        var result = await AddressLookup.LookupByDarIdAsync(suggestion.DarId, CancellationToken.None);
        _selectedMeteringPoints.AddRange(result.MeteringPoints);
        StateHasChanged();
    }

    private void StartChangeOfSupplier(MeteringPointInfo mp)
    {
        var actionId = Interlocked.Increment(ref _actionCounter);
        var action = new ActionViewModel
        {
            Id = actionId,
            Gsrn = mp.Gsrn,
            Address = _selectedAddress,
            ActionType = "Change of Supplier",
            TotalSteps = 8,
            Status = ActionStatus.Running,
            CurrentStepName = "Starting...",
        };
        _actions.Insert(0, action);

        _selectedMeteringPoints.Clear();
        _searchQuery = "";
        _addressSelected = false;

        _ = RunActionAsync(action);
    }

    private void StartMoveIn(MeteringPointInfo mp)
    {
        var actionId = Interlocked.Increment(ref _actionCounter);
        var action = new ActionViewModel
        {
            Id = actionId,
            Gsrn = mp.Gsrn,
            Address = _selectedAddress,
            ActionType = "Move In",
            TotalSteps = 8,
            Status = ActionStatus.Running,
            CurrentStepName = "Starting...",
        };
        _actions.Insert(0, action);

        _selectedMeteringPoints.Clear();
        _searchQuery = "";
        _addressSelected = false;

        _ = RunActionAsync(action);
    }

    private void StartFollowUp(ActionViewModel action, string actionType, int totalSteps)
    {
        action.ActionType = actionType;
        action.TotalSteps = totalSteps;
        action.Status = ActionStatus.Running;
        action.CompletedSteps = 0;
        action.CurrentStepName = "Starting...";
        action.CurrentStepDetails = null;
        action.Result = null;
        action.ErrorMessage = null;

        _ = RunActionAsync(action);
    }

    private async Task RunActionAsync(ActionViewModel action)
    {
        try
        {
            var stepCallback = new Func<SimulationStep, Task>(async step =>
            {
                await InvokeAsync(() =>
                {
                    action.CompletedSteps = step.Number;
                    action.CurrentStepName = step.Name;
                    action.CurrentStepDetails = step.Details;

                    if (step.Number == action.TotalSteps && step.Details is not null)
                        action.Result = step.Details;

                    StateHasChanged();
                });
            });

            switch (action.ActionType)
            {
                case "Change of Supplier":
                    await Simulator.RunChangeOfSupplierAsync(action.Gsrn, $"Customer #{action.Id}", stepCallback, CancellationToken.None);
                    break;
                case "Receive Metering":
                    await Simulator.ReceiveMeteringOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Run Settlement":
                    await Simulator.RunSettlementOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Offboard":
                    await Simulator.OffboardOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Aconto Billing":
                    await Simulator.AcontoBillingOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Move In":
                    await Simulator.RunMoveInAsync(action.Gsrn, $"Customer #{action.Id}", stepCallback, CancellationToken.None);
                    break;
                case "Move Out":
                    await Simulator.RunMoveOutAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
            }

            await InvokeAsync(() =>
            {
                action.CompletedOps.Add(action.ActionType);
                action.Status = ActionStatus.Completed;
                if (action.ActionType is "Offboard" or "Move Out")
                    action.IsOffboarded = true;
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                action.Status = ActionStatus.Failed;
                action.ErrorMessage = ex.Message;
                StateHasChanged();
            });
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
