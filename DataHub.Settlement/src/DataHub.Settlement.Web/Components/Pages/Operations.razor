@page "/operations"
@using System.Text.Json
@using DataHub.Settlement.Application.AddressLookup
@using DataHub.Settlement.Infrastructure.Dashboard
@inject IAddressLookupClient AddressLookup
@inject SimulationService Simulator
@inject SimulatedClock Clock
@inject IHttpClientFactory HttpClientFactory

<div style="display: flex; align-items: center; justify-content: space-between;">
    <h1>Operations</h1>
    <button class="ops-reset-btn" @onclick="ResetDatabaseAsync" disabled="@_resetting">
        @(_resetting ? "Resetting..." : "Reset Database")
    </button>
</div>
<p style="color: var(--text-muted); margin-bottom: 1.5rem;">
    Search an address, find metering points, and run concurrent change-of-supplier actions.
</p>

<!-- Clock Bar -->
<div class="ops-clock-bar">
    <div class="ops-clock-date">@Clock.CurrentDate.ToString("ddd, dd MMM yyyy")</div>
    <div class="ops-clock-controls">
        <button class="ops-clock-btn" @onclick="AdvanceOneDayAsync" disabled="@_ticking">+1 Day</button>
        <button class="ops-clock-btn ops-clock-btn-accent" @onclick="SkipToNextEventAsync" disabled="@_ticking">Skip to Next Event</button>
        <button class="ops-clock-btn" @onclick="AdvanceSevenDaysAsync" disabled="@_ticking">+7 Days</button>
    </div>
</div>

<!-- Address Search -->
<div class="ops-search-section">
    <div class="ops-search-wrapper">
        <input type="text"
               class="ops-search-input"
               placeholder="Search Danish address (e.g. Rendsburggade 1)..."
               value="@_searchQuery"
               @oninput="OnSearchInput" />
        @if (_suggestions.Count > 0 && !_addressSelected)
        {
            <div class="ops-suggestions">
                @foreach (var s in _suggestions)
                {
                    <div class="ops-suggestion" @onclick="() => SelectAddress(s)">@s.Text</div>
                }
            </div>
        }
    </div>
    @if (_searching)
    {
        <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 0.5rem;">Searching...</span>
    }
</div>

<!-- Metering Point Card -->
@if (_selectedMeteringPoints.Count > 0)
{
    <div class="ops-mp-cards">
        @foreach (var mp in _selectedMeteringPoints)
        {
            <div class="ops-mp-card">
                <div class="ops-mp-header">
                    <span class="ops-mp-gsrn">@mp.Gsrn</span>
                    <span class="badge badge-completed">@mp.Type</span>
                </div>
                <div class="ops-mp-details">
                    <span>Grid Area: @mp.GridAreaCode</span>
                    <span>@_selectedAddress</span>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                    <button class="btn" @onclick="() => StartChangeOfSupplier(mp)">
                        Change of Supplier
                    </button>
                    <button class="btn" @onclick="() => StartMoveIn(mp)">
                        Move In
                    </button>
                </div>
            </div>
        }
    </div>
}

<!-- Action List -->
@if (_actions.Count > 0)
{
    <h2 style="margin-top: 2rem; font-size: 1.1rem; font-weight: 600;">Actions</h2>
    <div class="ops-action-list">
        @foreach (var action in _actions)
        {
            var rowCss = action.Status switch
            {
                ActionStatus.Running => "ops-action ops-action-running",
                ActionStatus.WaitingForDate => "ops-action ops-action-waiting",
                ActionStatus.Completed => "ops-action ops-action-completed",
                ActionStatus.Failed => "ops-action ops-action-failed",
                _ => "ops-action",
            };
            var isExpanded = _expandedActionId == action.Id;
            <div class="@rowCss" style="flex-wrap: wrap;">
                <div class="ops-action-row" @onclick="@(() => ToggleExpandAsync(action))">
                    <div class="ops-action-id">#@action.Id</div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-weight: 600; font-size: 0.95rem;">@action.Gsrn</span>
                            @if (action.CompletedOps.Count > 0)
                            {
                                @foreach (var op in action.CompletedOps)
                                {
                                    <span class="ops-history-badge">@op</span>
                                }
                            }
                        </div>
                        <div style="font-size: 0.8rem; color: @(action.Status == ActionStatus.Failed ? "var(--red)" : "var(--text-muted)"); margin-top: 0.15rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            @if (action.Status == ActionStatus.Failed && action.ErrorMessage is not null)
                            {
                                <span>@action.ErrorMessage</span>
                            }
                            else if (action.Status == ActionStatus.Running)
                            {
                                <span>@action.ActionType — @action.CurrentStepDetails</span>
                            }
                            else if (action.Status == ActionStatus.WaitingForDate && action.MeteringDaysDelivered > 0 && action.MeteringDaysDelivered < action.TotalMeteringDays)
                            {
                                <span>@action.ActionType — RSM-012: @action.MeteringDaysDelivered/@action.TotalMeteringDays days received</span>
                            }
                            else if (action.Status == ActionStatus.WaitingForDate)
                            {
                                <span>@action.ActionType — waiting for @action.NextEventDate?.ToString("dd MMM"): @action.NextEventName</span>
                            }
                            else if (action.Result is not null)
                            {
                                @action.Result
                            }
                            else
                            {
                                @action.Address
                            }
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0;">
                        @switch (action.Status)
                        {
                            case ActionStatus.Running:
                                <span class="badge badge-sent">@action.CurrentStepName (@action.CompletedSteps/@action.TotalSteps)</span>
                                break;
                            case ActionStatus.WaitingForDate:
                                <span class="badge badge-waiting">@action.CompletedSteps/@action.TotalSteps</span>
                                break;
                            case ActionStatus.Completed:
                                <span class="badge badge-completed">ready</span>
                                @if (!action.IsOffboarded)
                                {
                                    <div class="ops-followup">
                                        <button class="ops-followup-btn" @onclick="@(() => StartFollowUp(action, "Receive Metering", 2))" @onclick:stopPropagation="true">Metering</button>
                                        <button class="ops-followup-btn" @onclick="@(() => StartFollowUp(action, "Run Settlement", 3))" @onclick:stopPropagation="true">Settlement</button>
                                        <button class="ops-followup-btn" @onclick="@(() => StartFollowUp(action, "Aconto Billing", 4))" @onclick:stopPropagation="true">Aconto</button>
                                        <button class="ops-followup-btn ops-followup-btn-warn" @onclick="@(() => StartFollowUp(action, "Offboard", 5))" @onclick:stopPropagation="true">Offboard</button>
                                        <button class="ops-followup-btn ops-followup-btn-warn" @onclick="@(() => StartFollowUp(action, "Move Out", 6))" @onclick:stopPropagation="true">Move Out</button>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge badge-dead-letter">offboarded</span>
                                }
                                break;
                            case ActionStatus.Failed:
                                <span class="badge badge-dead-letter">failed</span>
                                break;
                        }
                        <span class="ops-expand-icon">@(isExpanded ? "\u25B2" : "\u25BC")</span>
                    </div>
                </div>

                <!-- Timeline Strip (always visible for time-aware actions) -->
                @if (action.TimelineEvents is { Count: > 0 })
                {
                    <div class="ops-timeline-strip">
                        @foreach (var evt in action.TimelineEvents)
                        {
                            var isRsm012Daily = evt.Name == "RSM-012 Daily";
                            var isRsm012Done = isRsm012Daily && action.MeteringDaysDelivered >= action.TotalMeteringDays && action.TotalMeteringDays > 0;
                            var isRsm012InProgress = isRsm012Daily && action.MeteringDaysDelivered > 0 && !isRsm012Done;
                            var dotClass = (isRsm012Done || (action.CompletedTimelineSteps.Contains(evt.Name) && evt.Date <= Clock.CurrentDate))
                                ? "ops-tl-dot ops-tl-done"
                                : isRsm012InProgress
                                    ? "ops-tl-dot ops-tl-progress"
                                    : evt.Date <= Clock.CurrentDate && !isRsm012Daily
                                        ? "ops-tl-dot ops-tl-ready"
                                        : "ops-tl-dot ops-tl-future";
                            <div class="ops-tl-event">
                                <div class="@dotClass"></div>
                                <div class="ops-tl-label">
                                    <span class="ops-tl-date">@evt.Date.ToString("dd MMM")</span>
                                    @if (isRsm012Daily && action.TotalMeteringDays > 0)
                                    {
                                        <span class="ops-tl-name">RSM-012</span>
                                        <div class="ops-tl-progress-bar">
                                            <div class="ops-tl-progress-fill" style="width: @(action.TotalMeteringDays > 0 ? (int)(100.0 * action.MeteringDaysDelivered / action.TotalMeteringDays) : 0)%"></div>
                                        </div>
                                        <span class="ops-tl-progress-text">@action.MeteringDaysDelivered / @action.TotalMeteringDays</span>
                                    }
                                    else
                                    {
                                        <span class="ops-tl-name">@evt.Name</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (isExpanded && action.Summary is { } summary)
                {
                    <div class="ops-detail-panel">
                        <!-- Metering Point -->
                        <div class="ops-detail-section">
                            <div class="ops-detail-label">Metering Point</div>
                            <div class="ops-detail-row">
                                <span>Status: <strong>@summary.ConnectionStatus</strong></span>
                                @if (summary.ActivatedAt.HasValue)
                                {
                                    <span>Activated: @summary.ActivatedAt.Value.ToString("yyyy-MM-dd HH:mm")</span>
                                }
                                @if (summary.DeactivatedAt.HasValue)
                                {
                                    <span>Deactivated: @summary.DeactivatedAt.Value.ToString("yyyy-MM-dd HH:mm")</span>
                                }
                            </div>
                        </div>

                        <!-- Processes -->
                        @if (summary.Processes.Count > 0)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Processes</div>
                                @foreach (var p in summary.Processes)
                                {
                                    <div class="ops-detail-row">
                                        <span class="ops-detail-tag">@p.ProcessType</span>
                                        <span class="badge @(p.Status == "completed" ? "badge-completed" : p.Status == "final_settled" ? "badge-dead-letter" : "badge-sent")">@p.Status</span>
                                        @if (p.EffectiveDate.HasValue)
                                        {
                                            <span>from @p.EffectiveDate.Value</span>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        <!-- Supply Periods -->
                        @if (summary.SupplyPeriods.Count > 0)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Supply Periods</div>
                                @foreach (var sp in summary.SupplyPeriods)
                                {
                                    <div class="ops-detail-row">
                                        <span>@sp.StartDate &rarr; @(sp.EndDate?.ToString() ?? "ongoing")</span>
                                        @if (sp.EndReason is not null)
                                        {
                                            <span class="ops-detail-muted">(@sp.EndReason)</span>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        <!-- Metering Data -->
                        @if (summary.Metering is { } m)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Metering Data</div>
                                <div class="ops-detail-row">
                                    <span>@m.ReadingCount readings</span>
                                    <span>@m.TotalKwh.ToString("N1") kWh</span>
                                    <span class="ops-detail-muted">@m.FirstReading.ToString("yyyy-MM-dd") &ndash; @m.LastReading.ToString("yyyy-MM-dd")</span>
                                </div>
                            </div>
                        }

                        <!-- Settlements -->
                        @if (summary.Settlements.Count > 0)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Settlements</div>
                                @foreach (var s in summary.Settlements)
                                {
                                    <div class="ops-detail-row">
                                        <span>@s.PeriodStart &rarr; @s.PeriodEnd</span>
                                        <span><strong>@s.TotalAmount.ToString("N2") DKK</strong></span>
                                        <span class="ops-detail-muted">VAT @s.VatAmount.ToString("N2")</span>
                                        <span class="badge badge-completed">@s.Status</span>
                                    </div>
                                }
                            </div>
                        }

                        <!-- Aconto Payments -->
                        @if (summary.AcontoPayments.Count > 0)
                        {
                            <div class="ops-detail-section">
                                <div class="ops-detail-label">Aconto Payments</div>
                                @foreach (var a in summary.AcontoPayments)
                                {
                                    <div class="ops-detail-row">
                                        <span>@a.PeriodStart &rarr; @a.PeriodEnd</span>
                                        <span><strong>@a.Amount.ToString("N2") DKK</strong></span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else if (isExpanded && action.Summary is null)
                {
                    <div class="ops-detail-panel">
                        <span class="ops-detail-muted">Loading...</span>
                    </div>
                }
            </div>
        }
    </div>
}

<style>
    .ops-clock-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .ops-clock-date {
        font-size: 1.3rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
    }

    .ops-clock-controls {
        display: flex;
        gap: 0.4rem;
    }

    .ops-clock-btn {
        padding: 0.35rem 0.75rem;
        font-size: 0.78rem;
        font-weight: 600;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--bg-card);
        color: var(--text);
        cursor: pointer;
        transition: background 0.15s, border-color 0.15s;
    }

    .ops-clock-btn:hover:not(:disabled) {
        background: var(--bg-hover);
        border-color: var(--accent);
    }

    .ops-clock-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .ops-clock-btn-accent {
        border-color: var(--accent);
        color: var(--accent);
    }

    .ops-clock-btn-accent:hover:not(:disabled) {
        background: var(--accent);
        color: #fff;
    }

    .ops-action-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        cursor: pointer;
    }

    .ops-expand-icon {
        font-size: 0.6rem;
        color: var(--text-muted);
        margin-left: 0.25rem;
    }

    .ops-followup {
        display: flex;
        gap: 0.35rem;
        margin-left: 0.5rem;
    }

    .ops-followup-btn {
        padding: 0.2rem 0.5rem;
        font-size: 0.72rem;
        font-weight: 600;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--bg-card);
        color: var(--text);
        cursor: pointer;
        white-space: nowrap;
        transition: background 0.15s, border-color 0.15s;
    }

    .ops-followup-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent);
    }

    .ops-followup-btn-warn:hover {
        border-color: var(--red);
        color: var(--red);
    }

    .ops-history-badge {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        font-size: 0.65rem;
        font-weight: 600;
        border-radius: 3px;
        background: var(--bg-hover);
        color: var(--text-muted);
        white-space: nowrap;
    }

    .ops-detail-panel {
        width: 100%;
        border-top: 1px solid var(--border);
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .ops-detail-section {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .ops-detail-label {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
    }

    .ops-detail-row {
        display: flex;
        align-items: baseline;
        gap: 0.75rem;
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        background: var(--bg-hover);
    }

    .ops-detail-tag {
        font-weight: 600;
        min-width: 8rem;
    }

    .ops-detail-muted {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .ops-reset-btn {
        padding: 0.35rem 0.75rem;
        font-size: 0.78rem;
        font-weight: 600;
        border: 1px solid var(--red);
        border-radius: 4px;
        background: transparent;
        color: var(--red);
        cursor: pointer;
        transition: background 0.15s;
    }

    .ops-reset-btn:hover:not(:disabled) {
        background: var(--red);
        color: #fff;
    }

    .ops-reset-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .ops-action-waiting {
        border-left: 3px solid var(--accent);
    }

    .badge-waiting {
        background: var(--accent);
        color: #fff;
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    /* Timeline strip */
    .ops-timeline-strip {
        display: flex;
        align-items: flex-start;
        gap: 0;
        width: 100%;
        padding: 0.5rem 0 0.25rem 0.5rem;
        overflow-x: auto;
    }

    .ops-tl-event {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        min-width: 5rem;
        position: relative;
    }

    .ops-tl-event::after {
        content: '';
        position: absolute;
        top: 6px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: var(--border);
        z-index: 0;
    }

    .ops-tl-event:last-child::after {
        display: none;
    }

    .ops-tl-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        z-index: 1;
        flex-shrink: 0;
    }

    .ops-tl-done {
        background: #22c55e;
    }

    .ops-tl-ready {
        background: var(--accent);
        animation: pulse-dot 1.5s infinite;
    }

    .ops-tl-future {
        background: var(--border);
    }

    @@keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    .ops-tl-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 0.25rem;
        text-align: center;
    }

    .ops-tl-date {
        font-size: 0.65rem;
        font-weight: 700;
        color: var(--text-muted);
        font-variant-numeric: tabular-nums;
    }

    .ops-tl-name {
        font-size: 0.6rem;
        color: var(--text-muted);
        white-space: nowrap;
    }

    .ops-tl-progress {
        background: #f59e0b;
    }

    .ops-tl-progress-bar {
        width: 3rem;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        margin-top: 0.15rem;
        overflow: hidden;
    }

    .ops-tl-progress-fill {
        height: 100%;
        background: #22c55e;
        border-radius: 2px;
        transition: width 0.3s ease;
    }

    .ops-tl-progress-text {
        font-size: 0.65rem;
        font-weight: 700;
        color: var(--text);
        font-variant-numeric: tabular-nums;
        margin-top: 0.1rem;
    }
</style>

@code {
    private enum ActionStatus { Pending, Running, WaitingForDate, Completed, Failed }

    private sealed class ActionViewModel
    {
        public int Id { get; init; }
        public string Gsrn { get; init; } = "";
        public string Address { get; init; } = "";
        public string ActionType { get; set; } = "";
        public int TotalSteps { get; set; } = 7;
        public bool IsOffboarded { get; set; }
        public ActionStatus Status { get; set; }
        public int CompletedSteps { get; set; }
        public string? CurrentStepName { get; set; }
        public string? CurrentStepDetails { get; set; }
        public string? Result { get; set; }
        public string? ErrorMessage { get; set; }
        public List<string> CompletedOps { get; } = new();
        public MeteringPointSummary? Summary { get; set; }

        // Time-aware fields
        public bool IsTimeAware { get; set; }
        public ChangeOfSupplierContext? CosContext { get; set; }
        public MoveInContext? MoveInContext { get; set; }
        public IReadOnlyList<TimelineEvent>? TimelineEvents { get; set; }
        public HashSet<string> CompletedTimelineSteps { get; } = new();
        public string? NextEventName { get; set; }
        public DateOnly? NextEventDate { get; set; }

        // Metering progress
        public int MeteringDaysDelivered { get; set; }
        public int TotalMeteringDays { get; set; }
    }

    private record DawaSuggestion(string Text, string DarId);

    private string _searchQuery = "";
    private bool _searching;
    private bool _resetting;
    private bool _ticking;
    private bool _addressSelected;
    private string _selectedAddress = "";
    private int? _expandedActionId;
    private readonly List<DawaSuggestion> _suggestions = new();
    private readonly List<MeteringPointInfo> _selectedMeteringPoints = new();
    private readonly List<ActionViewModel> _actions = new();
    private int _actionCounter;
    private Timer? _debounceTimer;

    private async Task ResetDatabaseAsync()
    {
        _resetting = true;
        StateHasChanged();

        await Simulator.ResetAsync();
        Clock.Reset();

        _actions.Clear();
        _expandedActionId = null;
        _resetting = false;
        StateHasChanged();
    }

    private async Task AdvanceOneDayAsync()
    {
        Clock.AdvanceDays(1);
        await TickAllActionsAsync();
    }

    private async Task AdvanceSevenDaysAsync()
    {
        Clock.AdvanceDays(7);
        await TickAllActionsAsync();
    }

    private async Task SkipToNextEventAsync()
    {
        // Find the earliest future event across all time-aware actions
        DateOnly? earliest = null;
        foreach (var action in _actions.Where(a => a.IsTimeAware && a.Status == ActionStatus.WaitingForDate))
        {
            var timeline = action.CosContext?.Timeline ?? action.MoveInContext?.Timeline;
            if (timeline is null) continue;

            var nextEvt = timeline.Events
                .Where(e => e.Date > Clock.CurrentDate && !action.CompletedTimelineSteps.Contains(e.Name))
                .OrderBy(e => e.Date)
                .FirstOrDefault();

            if (nextEvt is not null && (earliest is null || nextEvt.Date < earliest))
                earliest = nextEvt.Date;
        }

        if (earliest is not null)
        {
            Clock.AdvanceTo(earliest.Value);
            await TickAllActionsAsync();
        }
    }

    private async Task TickAllActionsAsync()
    {
        _ticking = true;
        StateHasChanged();

        foreach (var action in _actions.Where(a => a.IsTimeAware && a.Status == ActionStatus.WaitingForDate))
        {
            try
            {
                List<SimulationStep> executed;
                if (action.CosContext is { } cosCtx)
                {
                    executed = await Simulator.TickChangeOfSupplierAsync(cosCtx, Clock.CurrentDate, CancellationToken.None);
                }
                else if (action.MoveInContext is { } miCtx)
                {
                    executed = await Simulator.TickMoveInAsync(miCtx, Clock.CurrentDate, CancellationToken.None);
                }
                else continue;

                foreach (var step in executed)
                {
                    action.CompletedSteps = step.Number;
                    action.CurrentStepName = step.Name;
                    action.CurrentStepDetails = step.Details;
                    if (step.Name == "Receive RSM-012")
                    {
                        SyncMeteringProgress(action);
                        if (action.MeteringDaysDelivered > 0)
                            action.CompletedTimelineSteps.Add("RSM-012 Daily");
                    }
                    else
                    {
                        action.CompletedTimelineSteps.Add(step.Name);
                    }
                }

                // Check if all steps done
                var isComplete = action.CosContext is not null
                    ? action.CosContext.IsSettled
                    : action.MoveInContext?.IsSettled ?? false;

                if (isComplete)
                {
                    action.Status = ActionStatus.Completed;
                    action.CompletedOps.Add(action.ActionType);
                    action.Result = action.CurrentStepDetails;
                }
                else
                {
                    UpdateNextEvent(action);
                }
            }
            catch (Exception ex)
            {
                action.Status = ActionStatus.Failed;
                action.ErrorMessage = ex.Message;
            }
        }

        _ticking = false;
        StateHasChanged();
    }

    private static void SyncMeteringProgress(ActionViewModel action)
    {
        if (action.CosContext is { } cos)
        {
            action.MeteringDaysDelivered = cos.MeteringDaysDelivered;
            action.TotalMeteringDays = cos.TotalMeteringDays;
        }
        else if (action.MoveInContext is { } mi)
        {
            action.MeteringDaysDelivered = mi.MeteringDaysDelivered;
            action.TotalMeteringDays = mi.TotalMeteringDays;
        }
    }

    private void UpdateNextEvent(ActionViewModel action)
    {
        var timeline = action.CosContext?.Timeline ?? action.MoveInContext?.Timeline;
        if (timeline is null) return;

        var nextEvt = timeline.Events
            .Where(e => !action.CompletedTimelineSteps.Contains(e.Name))
            .OrderBy(e => e.Date)
            .FirstOrDefault();

        action.NextEventName = nextEvt?.Name;
        action.NextEventDate = nextEvt?.Date;
    }

    private async Task ToggleExpandAsync(ActionViewModel action)
    {
        if (_expandedActionId == action.Id)
        {
            _expandedActionId = null;
            return;
        }

        _expandedActionId = action.Id;
        action.Summary = null;
        StateHasChanged();

        action.Summary = await Simulator.GetMeteringPointSummaryAsync(action.Gsrn, CancellationToken.None);
        StateHasChanged();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _searchQuery = e.Value?.ToString() ?? "";
        _addressSelected = false;
        _debounceTimer?.Dispose();
        if (_searchQuery.Length < 2)
        {
            _suggestions.Clear();
            return;
        }
        var query = _searchQuery;
        _debounceTimer = new Timer(_ => InvokeAsync(() => SearchAddressAsync(query)), null, 300, Timeout.Infinite);
    }

    private async Task SearchAddressAsync(string query)
    {
        _searching = true;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient();
            var url = $"https://api.dataforsyningen.dk/adresser/autocomplete?q={Uri.EscapeDataString(query)}";
            var response = await client.GetStringAsync(url);
            var items = JsonSerializer.Deserialize<JsonElement[]>(response) ?? [];

            _suggestions.Clear();
            foreach (var item in items.Take(8))
            {
                var text = item.GetProperty("tekst").GetString() ?? "";
                var darId = item.GetProperty("adresse").GetProperty("id").GetString() ?? "";
                _suggestions.Add(new DawaSuggestion(text, darId));
            }
        }
        catch
        {
            _suggestions.Clear();
        }
        finally
        {
            _searching = false;
            StateHasChanged();
        }
    }

    private async Task SelectAddress(DawaSuggestion suggestion)
    {
        _searchQuery = suggestion.Text;
        _selectedAddress = suggestion.Text;
        _addressSelected = true;
        _suggestions.Clear();
        _selectedMeteringPoints.Clear();

        var result = await AddressLookup.LookupByDarIdAsync(suggestion.DarId, CancellationToken.None);
        _selectedMeteringPoints.AddRange(result.MeteringPoints);
        StateHasChanged();
    }

    private DateOnly ComputeEffectiveDate()
    {
        var today = Clock.CurrentDate;
        // Effective date = first of next month (or current month if today is already the 1st)
        var effective = today.Day == 1
            ? today
            : new DateOnly(today.Year, today.Month, 1).AddMonths(1);
        return effective;
    }

    private async Task StartChangeOfSupplier(MeteringPointInfo mp)
    {
        var actionId = Interlocked.Increment(ref _actionCounter);
        var effectiveDate = ComputeEffectiveDate();
        var cosCtx = new ChangeOfSupplierContext(mp.Gsrn, $"Customer #{actionId}", effectiveDate);

        var action = new ActionViewModel
        {
            Id = actionId,
            Gsrn = mp.Gsrn,
            Address = _selectedAddress,
            ActionType = "Change of Supplier",
            TotalSteps = 7,
            Status = ActionStatus.WaitingForDate,
            IsTimeAware = true,
            CosContext = cosCtx,
            TimelineEvents = cosCtx.Timeline.Events,
            TotalMeteringDays = cosCtx.TotalMeteringDays,
        };
        UpdateNextEvent(action);
        _actions.Insert(0, action);

        _selectedMeteringPoints.Clear();
        _searchQuery = "";
        _addressSelected = false;

        // Execute any steps already due at the current clock date
        await TickSingleActionAsync(action);
        StateHasChanged();
    }

    private async Task StartMoveIn(MeteringPointInfo mp)
    {
        var actionId = Interlocked.Increment(ref _actionCounter);
        var effectiveDate = ComputeEffectiveDate();
        var miCtx = new MoveInContext(mp.Gsrn, $"Customer #{actionId}", effectiveDate);

        var action = new ActionViewModel
        {
            Id = actionId,
            Gsrn = mp.Gsrn,
            Address = _selectedAddress,
            ActionType = "Move In",
            TotalSteps = 7,
            Status = ActionStatus.WaitingForDate,
            IsTimeAware = true,
            MoveInContext = miCtx,
            TimelineEvents = miCtx.Timeline.Events,
            TotalMeteringDays = miCtx.TotalMeteringDays,
        };
        UpdateNextEvent(action);
        _actions.Insert(0, action);

        _selectedMeteringPoints.Clear();
        _searchQuery = "";
        _addressSelected = false;

        await TickSingleActionAsync(action);
        StateHasChanged();
    }

    private async Task TickSingleActionAsync(ActionViewModel action)
    {
        try
        {
            List<SimulationStep> executed;
            if (action.CosContext is { } cosCtx)
                executed = await Simulator.TickChangeOfSupplierAsync(cosCtx, Clock.CurrentDate, CancellationToken.None);
            else if (action.MoveInContext is { } miCtx)
                executed = await Simulator.TickMoveInAsync(miCtx, Clock.CurrentDate, CancellationToken.None);
            else return;

            foreach (var step in executed)
            {
                action.CompletedSteps = step.Number;
                action.CurrentStepName = step.Name;
                action.CurrentStepDetails = step.Details;
                if (step.Name == "Receive RSM-012")
                {
                    SyncMeteringProgress(action);
                    if (action.MeteringDaysDelivered > 0)
                        action.CompletedTimelineSteps.Add("RSM-012 Daily");
                }
                else
                {
                    action.CompletedTimelineSteps.Add(step.Name);
                }
            }

            var isComplete = action.CosContext?.IsSettled ?? action.MoveInContext?.IsSettled ?? false;
            if (isComplete)
            {
                action.Status = ActionStatus.Completed;
                action.CompletedOps.Add(action.ActionType);
                action.Result = action.CurrentStepDetails;
            }
            else
            {
                UpdateNextEvent(action);
            }
        }
        catch (Exception ex)
        {
            action.Status = ActionStatus.Failed;
            action.ErrorMessage = ex.Message;
        }
    }

    private void StartFollowUp(ActionViewModel action, string actionType, int totalSteps)
    {
        action.ActionType = actionType;
        action.TotalSteps = totalSteps;
        action.Status = ActionStatus.Running;
        action.CompletedSteps = 0;
        action.CurrentStepName = "Starting...";
        action.CurrentStepDetails = null;
        action.Result = null;
        action.ErrorMessage = null;
        action.IsTimeAware = false;

        _ = RunActionAsync(action);
    }

    private async Task RunActionAsync(ActionViewModel action)
    {
        try
        {
            var stepCallback = new Func<SimulationStep, Task>(async step =>
            {
                await InvokeAsync(() =>
                {
                    action.CompletedSteps = step.Number;
                    action.CurrentStepName = step.Name;
                    action.CurrentStepDetails = step.Details;

                    if (step.Number == action.TotalSteps && step.Details is not null)
                        action.Result = step.Details;

                    StateHasChanged();
                });
            });

            switch (action.ActionType)
            {
                case "Receive Metering":
                    await Simulator.ReceiveMeteringOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Run Settlement":
                    await Simulator.RunSettlementOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Offboard":
                    await Simulator.OffboardOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Aconto Billing":
                    await Simulator.AcontoBillingOpsAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
                case "Move Out":
                    await Simulator.RunMoveOutAsync(action.Gsrn, stepCallback, CancellationToken.None);
                    break;
            }

            await InvokeAsync(() =>
            {
                action.CompletedOps.Add(action.ActionType);
                action.Status = ActionStatus.Completed;
                if (action.ActionType is "Offboard" or "Move Out")
                    action.IsOffboarded = true;
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                action.Status = ActionStatus.Failed;
                action.ErrorMessage = ex.Message;
                StateHasChanged();
            });
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
