@page "/cim-viewer"
@using DataHub.Settlement.Infrastructure.Dashboard
@inject SimulationService Simulator

<div class="mb-8">
    <h1 class="text-2xl font-extrabold text-white tracking-tight">CIM Messages</h1>
    <p class="text-sm text-slate-400 mt-1">Browse all stored CIM messages from simulation runs.</p>
</div>

@{
    string DirectionBadgeCss(string direction) => direction switch
    {
        "outbound" => "bg-sky-500/15 text-sky-400",
        "inbound" => "bg-emerald-500/15 text-emerald-400",
        _ => "bg-slate-500/15 text-slate-400",
    };
}

<!-- Filter Bar -->
<div class="flex items-center gap-4 mb-6 px-5 py-3.5 bg-white/[0.03] backdrop-blur-sm border border-white/[0.06] rounded-xl">
    <input type="text"
           class="flex-1 max-w-xs px-3 py-2 text-sm font-sans bg-slate-950 border border-white/[0.08] rounded-lg text-slate-200 placeholder-slate-600 outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/20 transition-all duration-150"
           placeholder="Filter by GSRN..."
           value="@_gsrnFilter"
           @oninput="OnGsrnFilterInput" />
    <select class="px-3 py-2 text-sm font-sans bg-slate-950 border border-white/[0.08] rounded-lg text-slate-200 outline-none cursor-pointer focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/20 transition-all duration-150"
            @onchange="OnDirectionFilterChange">
        <option value="">All Directions</option>
        <option value="outbound">Outbound</option>
        <option value="inbound">Inbound</option>
        <option value="internal">Internal</option>
    </select>
    <button class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white text-sm font-semibold rounded-lg shadow-lg shadow-blue-500/20 transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed"
            @onclick="RefreshAsync" disabled="@_loading">
        @(_loading ? "Loading..." : "Refresh")
    </button>
</div>

<!-- Table -->
@if (_messages.Count > 0)
{
    <div class="bg-white/[0.03] backdrop-blur-sm border border-white/[0.06] rounded-xl overflow-hidden">
        <table class="w-full">
            <thead>
                <tr class="bg-white/[0.04]">
                    <th class="px-5 py-3 text-left text-[0.65rem] font-semibold uppercase tracking-wider text-slate-500">GSRN</th>
                    <th class="px-5 py-3 text-left text-[0.65rem] font-semibold uppercase tracking-wider text-slate-500">Step</th>
                    <th class="px-5 py-3 text-left text-[0.65rem] font-semibold uppercase tracking-wider text-slate-500">Direction</th>
                    <th class="px-5 py-3 text-left text-[0.65rem] font-semibold uppercase tracking-wider text-slate-500">Timestamp</th>
                    <th class="px-5 py-3 text-left text-[0.65rem] font-semibold uppercase tracking-wider text-slate-500"></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/[0.04]">
                @foreach (var msg in _messages)
                {
                    <tr class="hover:bg-white/[0.02] transition-colors duration-150 cursor-pointer" @onclick="() => ShowMessage(msg)">
                        <td class="px-5 py-2.5 text-sm font-mono font-semibold text-slate-200 tabular-nums">@msg.Gsrn</td>
                        <td class="px-5 py-2.5 text-sm text-slate-300">@msg.StepName</td>
                        <td class="px-5 py-2.5">
                            <span class="inline-block px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide rounded-md @DirectionBadgeCss(msg.Direction)">@msg.Direction</span>
                        </td>
                        <td class="px-5 py-2.5 text-xs font-mono text-slate-500 tabular-nums">@msg.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td class="px-5 py-2.5">
                            <button class="px-2.5 py-1 text-[0.7rem] font-semibold border border-white/[0.08] rounded bg-white/[0.03] text-slate-400 hover:bg-blue-500 hover:border-blue-500 hover:text-white transition-all duration-150">View</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else if (!_loading)
{
    <div class="text-center py-16 text-slate-500 text-sm bg-white/[0.02] backdrop-blur-sm rounded-xl border border-white/[0.04]">
        No CIM messages recorded yet. Run a simulation on the <a href="operations" class="text-blue-400 hover:underline">Operations</a> page.
    </div>
}

<!-- Modal -->
@if (_selectedMessage is not null)
{
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center" @onclick="CloseMessage">
        <div class="bg-slate-900 border border-white/[0.08] rounded-xl max-w-3xl w-[92%] max-h-[82vh] flex flex-col shadow-2xl shadow-black/40" @onclick:stopPropagation="true">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-white/[0.06] flex-shrink-0">
                <div class="flex items-center gap-3">
                    <span class="font-bold text-sm text-white">@_selectedMessage.StepName</span>
                    <span class="inline-block px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide rounded-md @DirectionBadgeCss(_selectedMessage.Direction)">@_selectedMessage.Direction</span>
                </div>
                <button class="text-slate-500 hover:text-white text-xl leading-none transition-colors duration-150" @onclick="CloseMessage">&times;</button>
            </div>
            <!-- Meta -->
            <div class="flex items-center gap-6 px-6 py-2.5 text-xs text-slate-500 border-b border-white/[0.06] bg-white/[0.02] flex-shrink-0">
                <span>GSRN: <strong class="text-slate-300">@_selectedMessage.Gsrn</strong></span>
                <span class="font-mono tabular-nums">@_selectedMessage.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</span>
            </div>
            <!-- JSON Body -->
            <pre class="m-0 px-6 py-5 overflow-y-auto text-xs leading-relaxed whitespace-pre-wrap break-words font-mono text-slate-300 bg-slate-950 rounded-b-xl">@_selectedMessage.RawPayload</pre>
        </div>
    </div>
}

@code {
    private List<MessageAuditEntry> _messages = new();
    private string _gsrnFilter = "";
    private string? _directionFilter;
    private bool _loading;
    private MessageAuditEntry? _selectedMessage;
    private Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        _loading = true;
        StateHasChanged();

        var gsrn = string.IsNullOrWhiteSpace(_gsrnFilter) ? null : _gsrnFilter.Trim();
        _messages = (await Simulator.GetMessageAuditListAsync(gsrn, _directionFilter, CancellationToken.None)).ToList();

        _loading = false;
        StateHasChanged();
    }

    private void OnGsrnFilterInput(ChangeEventArgs e)
    {
        _gsrnFilter = e.Value?.ToString() ?? "";
        _debounceTimer?.Dispose();
        var filter = _gsrnFilter;
        _debounceTimer = new Timer(_ => InvokeAsync(RefreshAsync), null, 400, Timeout.Infinite);
    }

    private async Task OnDirectionFilterChange(ChangeEventArgs e)
    {
        var val = e.Value?.ToString();
        _directionFilter = string.IsNullOrEmpty(val) ? null : val;
        await RefreshAsync();
    }

    private void ShowMessage(MessageAuditEntry msg)
    {
        _selectedMessage = msg;
    }

    private void CloseMessage()
    {
        _selectedMessage = null;
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
