@page "/simulation"
@using DataHub.Settlement.Infrastructure.Dashboard
@inject SimulationService Simulator

<div class="mb-8">
    <h1 class="text-2xl font-extrabold text-white tracking-tight">Simulation</h1>
    <p class="text-sm text-slate-400 mt-1">Walk through settlement scenarios: onboarding, rejection, aconto billing, cancellation, move-in, move-out.</p>
</div>

<!-- Scenario Selector -->
<div class="flex flex-wrap items-center gap-2 mb-6">
    @foreach (var scenario in _scenarios)
    {
        var isActive = scenario.Key == _selectedScenario;
        var btnCss = isActive
            ? "px-4 py-2 text-sm font-semibold rounded-lg bg-blue-500/20 text-blue-400 border border-blue-500/30 shadow-sm shadow-blue-500/10"
            : "px-4 py-2 text-sm font-semibold rounded-lg bg-white/[0.03] text-slate-400 border border-white/[0.06] hover:bg-white/[0.06] hover:text-slate-200 transition-all duration-150";
        <button class="@btnCss" disabled="@_running" @onclick="() => SelectScenario(scenario.Key)">
            @scenario.Value.Label
        </button>
    }
</div>

<!-- Action Bar -->
<div class="flex items-center gap-3 mb-8">
    @if (_completed && !_running)
    {
        <button class="px-5 py-2.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white text-sm font-semibold rounded-lg shadow-lg shadow-blue-500/20 hover:shadow-blue-500/30 transition-all duration-200" @onclick="ResetAndRunAsync">
            Reset &amp; Run Again
        </button>
    }
    else
    {
        <button class="px-5 py-2.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white text-sm font-semibold rounded-lg shadow-lg shadow-blue-500/20 hover:shadow-blue-500/30 transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:shadow-blue-500/20" @onclick="StartAsync" disabled="@_running">
            @if (_running)
            {
                <span>Running...</span>
            }
            else
            {
                <span>Start Simulation</span>
            }
        </button>
    }
    @if (_errorMessage is not null)
    {
        <span class="text-sm text-rose-400">@_errorMessage</span>
    }
</div>

<!-- Step List -->
<div class="relative flex flex-col gap-0 mb-8">
    <!-- Vertical connecting line -->
    <div class="absolute left-[1.15rem] top-4 bottom-4 w-px bg-white/[0.06]"></div>

    @foreach (var step in _steps)
    {
        var (ringCss, dotCss) = step.Status switch
        {
            StepStatus.Running => ("ring-2 ring-amber-400/50", "bg-amber-400"),
            StepStatus.Completed => ("ring-2 ring-emerald-400/30", "bg-emerald-400"),
            StepStatus.Failed => ("ring-2 ring-rose-400/30", "bg-rose-400"),
            _ => ("ring-1 ring-white/10", "bg-slate-600"),
        };
        var textCss = step.Status switch
        {
            StepStatus.Completed => "text-slate-200",
            StepStatus.Failed => "text-rose-300",
            StepStatus.Running => "text-white",
            _ => "text-slate-500",
        };
        var badgeCss = step.Status switch
        {
            StepStatus.Running => "bg-amber-500/15 text-amber-400",
            StepStatus.Completed => "bg-emerald-500/15 text-emerald-400",
            StepStatus.Failed => "bg-rose-500/15 text-rose-400",
            _ => "bg-slate-500/15 text-slate-500",
        };
        var badgeText = step.Status switch
        {
            StepStatus.Running => "running",
            StepStatus.Completed => "done",
            StepStatus.Failed => "failed",
            _ => "pending",
        };
        <div class="relative flex items-center gap-4 py-2.5 px-3">
            <!-- Number dot -->
            <div class="relative z-10 flex items-center justify-center w-[2.3rem] h-[2.3rem] rounded-full bg-slate-900 @ringCss flex-shrink-0">
                <div class="w-2.5 h-2.5 rounded-full @dotCss"></div>
            </div>
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="text-sm font-semibold @textCss">@step.Name</div>
                @if (step.Details is not null)
                {
                    <div class="text-xs text-slate-500 mt-0.5 truncate">@step.Details</div>
                }
            </div>
            <!-- Badge -->
            <span class="inline-block px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide rounded-md @badgeCss flex-shrink-0">@badgeText</span>
        </div>
    }
</div>

<!-- Activity Log -->
@if (_log.Count > 0)
{
    <h2 class="text-lg font-semibold text-white mb-4">Activity Log</h2>
    <div class="bg-white/[0.03] backdrop-blur-sm border border-white/[0.06] rounded-xl overflow-hidden">
        <table class="w-full">
            <thead>
                <tr class="bg-white/[0.04]">
                    <th class="px-5 py-3 text-left text-[0.65rem] font-semibold uppercase tracking-wider text-slate-500 w-24">Time</th>
                    <th class="px-5 py-3 text-left text-[0.65rem] font-semibold uppercase tracking-wider text-slate-500 w-48">Step</th>
                    <th class="px-5 py-3 text-left text-[0.65rem] font-semibold uppercase tracking-wider text-slate-500">Details</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/[0.04]">
                @foreach (var entry in _log)
                {
                    <tr class="hover:bg-white/[0.02] transition-colors duration-150">
                        <td class="px-5 py-2.5 text-sm font-mono text-slate-300 tabular-nums">@entry.Timestamp.ToString("HH:mm:ss.f")</td>
                        <td class="px-5 py-2.5 text-sm text-slate-300">@entry.StepName</td>
                        <td class="px-5 py-2.5 text-sm text-slate-400">@entry.Details</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private enum StepStatus { Pending, Running, Completed, Failed }

    private sealed class StepViewModel
    {
        public int Number { get; init; }
        public string Name { get; init; } = "";
        public StepStatus Status { get; set; }
        public string? Details { get; set; }
    }

    private record LogEntry(DateTime Timestamp, string StepName, string Details);

    private record ScenarioDefinition(string Label, string[] StepNames, int? FailedStep);

    private static readonly Dictionary<string, ScenarioDefinition> _scenarios = new()
    {
        ["sunshine"] = new("Sunshine", [
            "Seed Reference Data",
            "Create Customer & Product",
            "Create Metering Point",
            "Submit BRS-001",
            "DataHub Acknowledges",
            "Receive RSM-007",
            "Complete Process",
            "Receive RSM-012",
            "Run Settlement",
            "Incoming BRS-001",
            "Receive Final RSM-012",
            "Run Final Settlement",
        ], null),
        ["rejection"] = new("Rejection & Retry", [
            "Seed Reference Data",
            "Create Customer & Product",
            "Create Metering Point",
            "Submit BRS-001",
            "DataHub Rejects",
            "Retry with New BRS-001",
            "DataHub Acknowledges Retry",
            "Process Completes",
        ], 5),
        ["aconto"] = new("Aconto Billing", [
            "Seed Reference Data",
            "Create Customer & Product",
            "Create Metering Point",
            "Activate Metering Point",
            "Estimate Q1 Aconto",
            "Receive January Metering",
            "Receive February Metering",
            "Receive March Metering",
            "Run Q1 Settlement",
            "Aconto Reconciliation",
            "Combined Invoice",
        ], null),
        ["cancellation"] = new("Cancellation", [
            "Seed Reference Data",
            "Create Customer & Product",
            "Create Metering Point",
            "Submit BRS-001",
            "DataHub Acknowledges",
            "Cancel Before Effectuation",
            "Verify Clean State",
        ], null),
        ["move_in"] = new("Move In", [
            "Seed Reference Data",
            "Create Customer & Product",
            "Create Metering Point",
            "Submit BRS-009",
            "DataHub Acknowledges",
            "Receive RSM-007",
            "Complete Process",
            "Receive RSM-012",
            "Run Settlement",
        ], null),
        ["move_out"] = new("Move Out", [
            "Seed Reference Data",
            "Create Customer & Product",
            "Create Metering Point",
            "Establish Supply",
            "Receive January RSM-012",
            "Run January Settlement",
            "Submit BRS-010",
            "DataHub Acknowledges",
            "Receive Final RSM-012",
            "Final Settlement + Deactivate",
        ], null),
    };

    private string _selectedScenario = "sunshine";
    private readonly List<StepViewModel> _steps = new();
    private readonly List<LogEntry> _log = new();
    private bool _running;
    private bool _completed;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        BuildStepList();

        var alreadySeeded = await Simulator.IsAlreadySeededAsync();
        if (alreadySeeded)
        {
            foreach (var step in _steps)
            {
                step.Status = StepStatus.Completed;
                step.Details = "Previously completed";
            }
            _completed = true;
        }
    }

    private void SelectScenario(string scenario)
    {
        if (_running) return;
        _selectedScenario = scenario;
        _completed = false;
        _errorMessage = null;
        _log.Clear();
        BuildStepList();
    }

    private void BuildStepList()
    {
        _steps.Clear();
        var def = _scenarios[_selectedScenario];
        for (var i = 0; i < def.StepNames.Length; i++)
        {
            _steps.Add(new StepViewModel { Number = i + 1, Name = def.StepNames[i] });
        }
    }

    private async Task ResetAndRunAsync()
    {
        _log.Clear();
        _completed = false;
        _errorMessage = null;
        BuildStepList();
        StateHasChanged();

        await StartAsync();
    }

    private async Task StartAsync()
    {
        _running = true;
        _errorMessage = null;
        _steps[0].Status = StepStatus.Running;
        StateHasChanged();

        await Simulator.ResetAsync();

        var failedStep = _scenarios[_selectedScenario].FailedStep;

        try
        {
            Func<SimulationStep, Task> onStep = step =>
            {
                var vm = _steps[step.Number - 1];
                vm.Details = step.Details;

                // Mark failed step with Failed status, all others as Completed
                vm.Status = (step.Number == failedStep) ? StepStatus.Failed : StepStatus.Completed;

                _log.Insert(0, new LogEntry(DateTime.Now, step.Name, step.Details));

                if (step.Number < _steps.Count)
                {
                    _steps[step.Number].Status = StepStatus.Running;
                }

                StateHasChanged();
                return Task.CompletedTask;
            };

            switch (_selectedScenario)
            {
                case "sunshine":
                    await Simulator.RunSunshineAsync(onStep, CancellationToken.None);
                    break;
                case "rejection":
                    await Simulator.RunRejectionRetryAsync(onStep, CancellationToken.None);
                    break;
                case "aconto":
                    await Simulator.RunAcontoQuarterlyAsync(onStep, CancellationToken.None);
                    break;
                case "cancellation":
                    await Simulator.RunCancellationAsync(onStep, CancellationToken.None);
                    break;
                case "move_in":
                    await Simulator.RunMoveInSunshineAsync(onStep, CancellationToken.None);
                    break;
                case "move_out":
                    await Simulator.RunMoveOutScenarioAsync(onStep, CancellationToken.None);
                    break;
            }

            _completed = true;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _running = false;
            StateHasChanged();
        }
    }
}
