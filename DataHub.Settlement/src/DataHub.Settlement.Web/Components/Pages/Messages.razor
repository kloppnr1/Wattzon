@page "/messages"
@using DataHub.Settlement.Infrastructure.Dashboard
@inject DashboardQueryService Queries

<h1>Messages</h1>

<div class="cards">
    <div class="card">
        <div class="label">Total Received</div>
        <div class="value">@_totalReceived</div>
    </div>
    <div class="card">
        <div class="label">Processed</div>
        <div class="value">@_processed</div>
    </div>
    <div class="card">
        <div class="label">Dead Letters</div>
        <div class="value">@_deadLetters</div>
    </div>
</div>

@if (_messages.Count == 0)
{
    <div class="empty-state">No messages yet. Start the worker to poll DataHub queues.</div>
}
else
{
    <table>
        <thead>
            <tr>
                <th>Message ID</th>
                <th>Type</th>
                <th>Queue</th>
                <th>Status</th>
                <th>Received At</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var msg in _messages)
            {
                <tr>
                    <td><code>@(msg.MessageId.Length > 12 ? msg.MessageId[..12] + "..." : msg.MessageId)</code></td>
                    <td>@msg.MessageType</td>
                    <td>@msg.Queue</td>
                    <td><span class="badge badge-@msg.Status.ToLowerInvariant()">@msg.Status</span></td>
                    <td>@msg.ReceivedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private int _totalReceived;
    private int _processed;
    private int _deadLetters;
    private List<DashboardQueryService.MessageEntry> _messages = new();

    protected override async Task OnInitializedAsync()
    {
        var counts = await Queries.GetMessageCountsAsync();
        _totalReceived = counts.TotalReceived;
        _processed = counts.Processed;
        _deadLetters = counts.DeadLetters;

        _messages = (await Queries.GetMessagesAsync()).ToList();
    }
}
